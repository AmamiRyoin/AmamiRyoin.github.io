<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT, AmamiRyoin, 765pro, idolm@ster, 天海流影, 天海春香, 前端, web, nodejs, javascript, js, mongodb, 偶像大师" />





  <link rel="alternate" href="/atom.xml" title="AmamiRyoin's Blog" type="application/atom+xml" />






<meta property="og:type" content="website">
<meta property="og:title" content="AmamiRyoin&#39;s Blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="AmamiRyoin&#39;s Blog">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="AmamiRyoin&#39;s Blog">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"hide","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/"/>





  <title>AmamiRyoin's Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">AmamiRyoin's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">守得云开见月明</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
      <!-- 自定义High一下的功能 -->
      <li class="menu-item"> <a title="把这个链接拖到你的工具栏中,任何网页都可以High" href='javascript:(
    function go() {


    var songs = [
        "/music/ashita.mp3",
        "/music/lemon.mp3",
    ];

    function c() {
        var e = document.createElement("link");
        e.setAttribute("type", "text/css");
        e.setAttribute("rel", "stylesheet");
        e.setAttribute("href", f);
        e.setAttribute("class", l);
        document.body.appendChild(e)
    }
 
    function h() {
        var e = document.getElementsByClassName(l);
        for (var t = 0; t < e.length; t++) {
            document.body.removeChild(e[t])
        }
    }
 
    function p() {
        var e = document.createElement("div");
        e.setAttribute("class", a);
        document.body.appendChild(e);
        setTimeout(function() {
            document.body.removeChild(e)
        }, 100)
    }
 
    function d(e) {
        return {
            height : e.offsetHeight,
            width : e.offsetWidth
        }
    }
 
    function v(i) {
        var s = d(i);
        return s.height > e && s.height < n && s.width > t && s.width < r
    }
 
    function m(e) {
        var t = e;
        var n = 0;
        while (!!t) {
            n += t.offsetTop;
            t = t.offsetParent
        }
        return n
    }
 
    function g() {
        var e = document.documentElement;
        if (!!window.innerWidth) {
            return window.innerHeight
        } else if (e && !isNaN(e.clientHeight)) {
            return e.clientHeight
        }
        return 0
    }
 
    function y() {
        if (window.pageYOffset) {
            return window.pageYOffset
        }
        return Math.max(document.documentElement.scrollTop, document.body.scrollTop)
    }
 
    function E(e) {
        var t = m(e);
        return t >= w && t <= b + w
    }

    function S() {
        var e = document.getElementById("audio_element_id");
        if(e != null){
            var index = parseInt(e.getAttribute("curSongIndex"));
            if(index > songs.length - 2) {
                index = 0;
            } else {
                index++;
            }
            e.setAttribute("curSongIndex", index);
            N();
        }

        e.src = i;
        e.play()
    }
 
    function x(e) {
        e.className += " " + s + " " + o
    }
 
    function T(e) {
        e.className += " " + s + " " + u[Math.floor(Math.random() * u.length)]
    }
 
    function N() {
        var e = document.getElementsByClassName(s);
        var t = new RegExp("\\b" + s + "\\b");
        for (var n = 0; n < e.length; ) {
            e[n].className = e[n].className.replace(t, "")
        }
    }

    function initAudioEle() {
        var e = document.getElementById("audio_element_id");
        if(e === null){
            e = document.createElement("audio");
            e.setAttribute("class", l);
            e.setAttribute("curSongIndex", 0);
            e.id = "audio_element_id";
            e.loop = false;
            e.bgcolor = 0;
            e.addEventListener("canplay", function() {
            setTimeout(function() {
                x(k)
            }, 500);
            setTimeout(function() {
                N();
                p();
                for (var e = 0; e < O.length; e++) {
                    T(O[e])
                }
            }, 15500)
        }, true);
        e.addEventListener("ended", function() {
            N();
            h();
            go();
        }, true);
        e.innerHTML = " <p>If you are reading this, it is because your browser does not support the audio element. We recommend that you get a new browser.</p> <p>";
        document.body.appendChild(e);
        }
    }
    
    initAudioEle();
    var e = 30;
    var t = 30;
    var n = 350;
    var r = 350;

    var curSongIndex = parseInt(document.getElementById("audio_element_id").getAttribute("curSongIndex"));
    var i = songs[curSongIndex];
    
    var s = "mw-harlem_shake_me";
    var o = "im_first";
    var u = ["im_drunk", "im_baked", "im_trippin", "im_blown"];
    var a = "mw-strobe_light";

    /* harlem-shake-style.css，替换成你的位置，也可以直接使用：//s3.amazonaws.com/moovweb-marketing/playground/harlem-shake-style.css */
    var f = "//s3.amazonaws.com/moovweb-marketing/playground/harlem-shake-style.css";
    
    var l = "mw_added_css";
    var b = g();
    var w = y();
    var C = document.getElementsByTagName("*");
    var k = null;
    for (var L = 0; L < C.length; L++) {
        var A = C[L];
        if (v(A)) {
            if (E(A)) {
                k = A;
                break
            }
        }
    }
    if (A === null) {
        console.warn("Could not find a node of the right size. Please try a different page.");
        return
    }
    c();
    S();
    var O = [];
    for (var L = 0; L < C.length; L++) {
        var A = C[L];
        if (v(A)) {
            O.push(A)
        }
    }
    })()'><i class="menu-item-icon fa fa-music fa-fw"></i>High一下</a> </li>
      <!-- end High一下 -->
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/03/09/svelte/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="AmamiRyoin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/headImg/head_Img.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="AmamiRyoin's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2021/03/09/svelte/" itemprop="url">Svelte浅谈</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2021-03-09T23:47:07+08:00">
                2021-03-09
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="探索Svelte"><a href="#探索Svelte" class="headerlink" title="探索Svelte"></a>探索Svelte</h2><h3 id="什么是Svelte"><a href="#什么是Svelte" class="headerlink" title="什么是Svelte"></a>什么是Svelte</h3><p><code>Svelte</code>本意是苗条纤瘦的，<code>Svelte</code>是一种构建用户界面的全新方法，它被预测为未来十年可能取代<code>React</code>和<code>Vue</code>等其他框架的新兴技术。作者是前端轮子哥 Rich Harris，同时也是 Rollup 的作者。</p>
<p>他设计 <code>Svelte</code> 的核心思想在于『通过静态编译减少框架运行时的代码量』，也就是说，<code>vue</code> 和 <code>react</code> 这类传统的框架，都必须引入运行时 (runtime) 代码，用于虚拟dom、diff 算法。Svelted完全溶入JavaScript，应用所有需要的运行时代码都包含在bundle.js里面了，除了引入这个组件本身，你不需要再额外引入一个运行代码。<br>从2019年开始, Svelte出现在榜单中。刚刚过去的2020年，Svelte在满意度排行榜中超越了react，跃升到了第一位。</p>
<h3 id="Svelte的优势"><a href="#Svelte的优势" class="headerlink" title="Svelte的优势"></a>Svelte的优势</h3><p>从容量大小来看，<code>Vue</code>58k，<code>React</code>97.5k，而<code>Svelte</code>只有9.7k。性能方面略逊<code>Vue</code>但是强于<code>React</code>。代码量方面碾压<code>Vue</code>和<code>React</code>。同时，Svelte自带数据框架。</p>
<h3 id="Svelte的劣势"><a href="#Svelte的劣势" class="headerlink" title="Svelte的劣势"></a>Svelte的劣势</h3><ul>
<li>没有像AntD那样成熟的UI库。</li>
<li>Svelte 原生不支持预处理器，比如说less/scss。</li>
<li>Svelte 原生脚手架没有目录划分。</li>
<li>暂时不支持typescript，虽然官方说了会支持, 但是不知道什么时候。</li>
</ul>
<h3 id="Svelte如何处理渲染问题"><a href="#Svelte如何处理渲染问题" class="headerlink" title="Svelte如何处理渲染问题"></a>Svelte如何处理渲染问题</h3><p>众所周知，<code>React</code>采用的虚拟DOM和diff算法来解决渲染问题，但是由于<code>React</code> 采用<code>jsx</code>语法本质不理解数据代表的意义，没有办法做出优化，因此才会出现诸如pureComponent，shouldComponentUpdate，useMemo，useCallback这些生命周期来控制重复渲染问题。</p>
<p>而<code>Svelte</code> 采用了<code>Templates</code>语法（类似于<code>Vue</code> 的写法），更加严格和具有语义性，可以在编译的过程中就进行优化操作。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">        &lt;p&gt;&#123;&#123;name&#125;&#125;&lt;/p&gt;</span><br><span class="line">        &lt;p&gt;8888&lt;/p&gt;</span><br><span class="line">        &lt;p&gt;8888&lt;/p&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure></p>
<p>编译器针对这块template代码可以很清楚地知道哪些代码是会变动，哪些代码不会变动。</p>
<h3 id="Svelte实例代码"><a href="#Svelte实例代码" class="headerlink" title="Svelte实例代码"></a>Svelte实例代码</h3><ul>
<li>小demo</li>
</ul>
<p>App.svelte<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">	import Button from &apos;./button.svelte&apos;</span><br><span class="line">	let name = &apos;world&apos;;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;h1&gt;Hello &#123;name&#125;!&lt;/h1&gt;</span><br><span class="line">&lt;Button/&gt;</span><br></pre></td></tr></table></figure></p>
<p>button.svelte<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">    let count = 0;</span><br><span class="line">    function handleClick() &#123;</span><br><span class="line">        count += 1;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;button on:click=&#123;handleClick&#125;&gt;</span><br><span class="line">	Clicked &#123;count&#125; &#123;count === 1 ? &apos;time&apos; : &apos;times&apos;&#125;</span><br><span class="line">&lt;/button&gt;</span><br></pre></td></tr></table></figure></p>
<ul>
<li><code>$:</code>响应式语句</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">let count = 0;</span><br><span class="line">$: doubled = count * 2;</span><br></pre></td></tr></table></figure>
<p>在 <code>Svelte</code> 中，以 <code>$:</code> 开头的语句就是响应式语句，<code>Svelte</code> 会自动分析响应式语句所依赖的变量，当依赖变量发生变化时，<code>Svelte</code> 就会重新执行相应的响应式语句。当 <code>Svelte</code> 看到任何带有 <code>$:</code> 前缀的语句时，它就知道要将右边的变量赋值给左边的变量，而不需要使用<code>let</code>将一个变量的值绑定到另一个变量；并且<code>Svelte</code>可以以响应式的方式运行任何语句。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$: console.log(`the count is $&#123;count&#125;`);</span><br><span class="line">$: &#123;</span><br><span class="line">	console.log(`the count is $&#123;count&#125;`);</span><br><span class="line">	alert(`I SAID THE COUNT IS $&#123;count&#125;`);</span><br><span class="line">&#125;</span><br><span class="line">$: if (count &gt;= 10) &#123;</span><br><span class="line">	alert(`count is dangerously high!`);</span><br><span class="line">	count = 9;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>但是<code>Svelte</code>的响应是基于赋值操作的，数组的 <code>push</code>、<code>splice</code> 等操作不会触发响应式更新。</p>
<ul>
<li>接收Props</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">	export let answer;</span><br><span class="line">    // export let answer = &apos;a mystery&apos;; 初始化value</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>生命周期</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">	import &#123; onMount,onDestroy,beforeUpdate,afterUpdate,tick &#125; from &apos;svelte&apos;;</span><br><span class="line"></span><br><span class="line">	let photos = [];</span><br><span class="line"></span><br><span class="line">	onMount(async () =&gt; &#123;</span><br><span class="line">		const res = await fetch(`https://jsonplaceholder.typicode.com/photos?_limit=20`);</span><br><span class="line">		photos = await res.json();</span><br><span class="line">	&#125;);</span><br><span class="line">    </span><br><span class="line">    onDestroy(() =&gt; alert(&apos;gg&apos;));</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>逻辑判断<br>由于HTML没有类似于逻辑判断的语法，因此<code>Svelte</code>加了个这个东西。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">	let user = &#123; loggedIn: false &#125;;</span><br><span class="line"></span><br><span class="line">	function toggle() &#123;</span><br><span class="line">		user.loggedIn = !user.loggedIn;</span><br><span class="line">	&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&#123;#if user.loggedIn&#125;</span><br><span class="line">	&lt;button on:click=&#123;toggle&#125;&gt;</span><br><span class="line">		Log out</span><br><span class="line">	&lt;/button&gt;</span><br><span class="line">&#123;/if&#125;</span><br><span class="line"></span><br><span class="line">&#123;#if !user.loggedIn&#125;</span><br><span class="line">	&lt;button on:click=&#123;toggle&#125;&gt;</span><br><span class="line">		Log in</span><br><span class="line">	&lt;/button&gt;</span><br><span class="line">&#123;/if&#125;</span><br><span class="line">//或</span><br><span class="line">&#123;#if user.loggedIn&#125;</span><br><span class="line">	&lt;button on:click=&#123;toggle&#125;&gt;</span><br><span class="line">		Log out</span><br><span class="line">	&lt;/button&gt;</span><br><span class="line">&#123;:else&#125;</span><br><span class="line">	&lt;button on:click=&#123;toggle&#125;&gt;</span><br><span class="line">		Log in</span><br><span class="line">	&lt;/button&gt;</span><br><span class="line">&#123;/if&#125;</span><br><span class="line">//或</span><br><span class="line">&#123;#if x &gt; 10&#125;</span><br><span class="line">	&lt;p&gt;&#123;x&#125; is greater than 10&lt;/p&gt;</span><br><span class="line">&#123;:else if 5 &gt; x&#125;</span><br><span class="line">	&lt;p&gt;&#123;x&#125; is less than 5&lt;/p&gt;</span><br><span class="line">&#123;:else&#125;</span><br><span class="line">	&lt;p&gt;&#123;x&#125; is between 5 and 10&lt;/p&gt;</span><br><span class="line">&#123;/if&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>遍历</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;#each cats as cat&#125;</span><br><span class="line">		&lt;li&gt;&lt;a target=&quot;_blank&quot; href=&quot;https://www.youtube.com/watch?v=&#123;cat.id&#125;&quot;&gt;</span><br><span class="line">        &#123;cat.name&#125;</span><br><span class="line">    &lt;/a&gt;&lt;/li&gt;</span><br><span class="line">&#123;/each&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>await</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;#await promise&#125;</span><br><span class="line">	&lt;p&gt;...waiting&lt;/p&gt;</span><br><span class="line">&#123;:then number&#125;</span><br><span class="line">	&lt;p&gt;The number is &#123;number&#125;&lt;/p&gt;</span><br><span class="line">&#123;:catch error&#125;</span><br><span class="line">	&lt;p style=&quot;color: red&quot;&gt;&#123;error.message&#125;&lt;/p&gt;</span><br><span class="line">&#123;/await&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><a href="https://www.sveltejs.cn/tutorial/await-blocks" target="_blank" rel="noopener">demo</a></p>
<ul>
<li>事件绑定<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;button on:click|once=&#123;handleClick&#125;&gt;</span><br><span class="line">	Click me</span><br><span class="line">&lt;/button&gt;</span><br><span class="line">&lt;button on:click=&#123;handleClick&#125;&gt;</span><br><span class="line">	Click me</span><br><span class="line">&lt;/button&gt;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>自定义事件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">	import Inner from &apos;./Inner.svelte&apos;;</span><br><span class="line"></span><br><span class="line">	function handleMessage(event) &#123;</span><br><span class="line">		alert(event.detail.text);</span><br><span class="line">	&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;Inner on:message=&#123;handleMessage&#125;/&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">	import &#123; createEventDispatcher &#125; from &apos;svelte&apos;;</span><br><span class="line"></span><br><span class="line">	const dispatch = createEventDispatcher();</span><br><span class="line"></span><br><span class="line">	function sayHello() &#123;</span><br><span class="line">		dispatch(&apos;message&apos;, &#123;</span><br><span class="line">			text: &apos;Hello!&apos;</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;button on:click=&#123;sayHello&#125;&gt;</span><br><span class="line">	Click to say hello</span><br><span class="line">&lt;/button&gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>Store<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">store.js</span><br><span class="line"></span><br><span class="line">import &#123; writable,readable,derived &#125; from &apos;svelte/store&apos;;</span><br><span class="line">export const count = writable(0);//writable类型的store有update和set两种subscribe方法</span><br><span class="line"></span><br><span class="line">export const time = readable(new Date(), function start(set) &#123;</span><br><span class="line">	const interval = setInterval(() =&gt; &#123;</span><br><span class="line">		set(new Date());</span><br><span class="line">	&#125;, 1000);</span><br><span class="line"></span><br><span class="line">	return function stop() &#123;</span><br><span class="line">		clearInterval(interval);</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;);</span><br><span class="line">//readable无法从外部进行更新,没有set（）或update（）方法。一旦设置了初始状态，便无法从外部进行修改。</span><br><span class="line"></span><br><span class="line">export const elapsed = derived(</span><br><span class="line">	time,</span><br><span class="line">	$time =&gt; Math.round(($time - 100*Math.random()) / 1000)</span><br><span class="line">);</span><br><span class="line">//derived允许您创建依赖于现有存储的值的新存储值</span><br><span class="line"></span><br><span class="line">app.svelte</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">	import &#123; count &#125; from &apos;./stores.js&apos;;</span><br><span class="line">	import Incrementer from &apos;./Incrementer.svelte&apos;;</span><br><span class="line">	import Decrementer from &apos;./Decrementer.svelte&apos;;</span><br><span class="line">	import Resetter from &apos;./Resetter.svelte&apos;;</span><br><span class="line"></span><br><span class="line">	let count_value;</span><br><span class="line"></span><br><span class="line">	const unsubscribe = count.subscribe(value =&gt; &#123;</span><br><span class="line">		count_value = value;</span><br><span class="line">	&#125;);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;h1&gt;The count is &#123;count_value&#125;&lt;/h1&gt;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>综上。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/12/02/webpack/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="AmamiRyoin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/headImg/head_Img.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="AmamiRyoin's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/02/webpack/" itemprop="url">webpack使用心得总结</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-12-02T17:10:03+08:00">
                2020-12-02
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="去除无用的样式"><a href="#去除无用的样式" class="headerlink" title="去除无用的样式"></a>去除无用的样式</h3><p>安装： npm i purgecss-webpack-plugin glob -D</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 去除无用的样式</span></span><br><span class="line"><span class="keyword">const</span> glob = <span class="built_in">require</span>(<span class="string">'glob'</span>);</span><br><span class="line"><span class="keyword">const</span> PurgecssWebpackPlugin = <span class="built_in">require</span>(<span class="string">'purgecss-webpack-plugin'</span>);</span><br><span class="line">plugins: [</span><br><span class="line">    <span class="keyword">new</span> HtmlWebpaclPlugin(&#123;</span><br><span class="line">        template: <span class="string">'./src/index.html'</span></span><br><span class="line">    &#125;),</span><br><span class="line">    <span class="keyword">new</span> MiniCssExtractPlugin(),</span><br><span class="line">    <span class="comment">// 去除无用的样式</span></span><br><span class="line">    <span class="keyword">new</span> PurgecssWebpackPlugin(&#123;</span><br><span class="line">        paths: glob.sync(<span class="string">'./src/**/*'</span>, &#123;<span class="attr">nodir</span>: <span class="literal">true</span>&#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>下面我们来简单分析分析：</p>
<p>glob是用来查找文件的<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">glob.sync(<span class="string">'./src/**/*'</span>, &#123;<span class="attr">nodir</span>: <span class="literal">true</span>&#125;</span><br><span class="line"><span class="comment">// 同步查找src目录下的任意文件夹下的任意文件</span></span><br><span class="line"><span class="comment">// 返回一个数组，如['真实路径/src/css/style.css','真实路径/src/index.js',...]</span></span><br><span class="line"><span class="comment">// &#123;nodir: true&#125;表示不包含文件夹，加快查找速度</span></span><br></pre></td></tr></table></figure></p>
<p>purgecss-webpack-plugin是去除无用的css<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> PurgecssWebpackPlugin(&#123;</span><br><span class="line">    <span class="comment">// paths表示指定要去解析的文件名数组路径</span></span><br><span class="line">    <span class="comment">// Purgecss会去解析这些文件然后把无用的样式移除</span></span><br><span class="line">    paths: glob.sync(<span class="string">'./src/**/*'</span>, &#123;<span class="attr">nodir</span>: <span class="literal">true</span>&#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<h3 id="动态添加CDN"><a href="#动态添加CDN" class="headerlink" title="动态添加CDN"></a>动态添加CDN</h3><p>在html文件中引入cdn文件，在webpack配置externals，这样就不会打包引入的cdn的库</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.html文件</span></span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;div id=<span class="string">"root"</span>&gt;&lt;/div&gt;</span><br><span class="line">    &lt;!-- 引入jquery的cdn --&gt;</span><br><span class="line">    &lt;script src=<span class="string">"https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js"</span>&gt;&lt;/script&gt;</span><br><span class="line">&lt;<span class="regexp">/body&gt;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ webpack.config.js文件</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">module.exports = &#123;</span></span><br><span class="line"><span class="regexp">    externals: &#123;</span></span><br><span class="line"><span class="regexp">        'jquery': '$'</span></span><br><span class="line"><span class="regexp">    &#125;   </span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p>这样写完后，在js文件中我们就可以不用再导入jquery也能直接使用$操作符了</p>
<p>由于每次都需要在index.html模板中手动引入需要的cdn文件，然后还要在webpack里配置，有点繁琐了</p>
<p>So，html-webpack-externals-plugin这样的插件就应运而生了<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 动态添加CDN</span></span><br><span class="line"><span class="keyword">const</span> HtmlWebpackExternalsPlugin = <span class="built_in">require</span>(<span class="string">'html-webpack-externals-plugin'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    plugins: [</span><br><span class="line">        <span class="keyword">new</span> HtmlWebpackExternalsPlugin(&#123;</span><br><span class="line">            externals: [</span><br><span class="line">                &#123;   <span class="comment">// 引入的模块</span></span><br><span class="line">                    <span class="built_in">module</span>: <span class="string">'jquery'</span>,</span><br><span class="line">                    <span class="comment">// cdn的地址</span></span><br><span class="line">                    entry: <span class="string">'https://cdn.bootcss.com/jquery/3.4.1/jquery.min.js'</span>,</span><br><span class="line">                    <span class="comment">// 挂载到了window上的名称</span></span><br><span class="line">                    <span class="comment">// window.jQuery就可以全局使用</span></span><br><span class="line">                    global: <span class="string">'jQuery'</span></span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;)</span><br><span class="line">    ]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h3 id="DllPlugin动态链接库"><a href="#DllPlugin动态链接库" class="headerlink" title="DllPlugin动态链接库"></a>DllPlugin动态链接库</h3><p>很多时候我们在开发时无论是用React还是Vue，我们都不希望这个开发的主力框架每次都被打包一遍，这样也是费时费力的事情</p>
<p>所以，出现了DllPlugin这种插件，它纯属webpack内置的，放心大胆的用</p>
<p><strong>作用：</strong></p>
<ol>
<li>在第一次打包的时候就把打包用到的开发框架直接打包好，然后会生成一个manifest.json文件</li>
<li>再打包的的时候，只要有import React from ‘react’这样的引用，它就会先去所谓的缓存文件里找，找到了就直接用，也不用再进行对react打包了</li>
<li>如果没找到的话，再对框架打包一遍也无伤大雅</li>
</ol>
<p><strong>创建动态链接库</strong><br>在根目录下创建一个webpack.dll.js文件，用来打包出dll文件<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="comment">// 引入webpack</span></span><br><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">'webpack'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    entry: [<span class="string">'react'</span>, <span class="string">'react-dom'</span>],</span><br><span class="line">    output: &#123;</span><br><span class="line">        filename: <span class="string">'react.dll.js'</span>,</span><br><span class="line">        path: path.resolve(<span class="string">'dll'</span>),</span><br><span class="line">        library: <span class="string">'react'</span>    <span class="comment">// 打包后被引用的变量名</span></span><br><span class="line">    &#125;,</span><br><span class="line">    plugins: [</span><br><span class="line">        <span class="comment">// 动态链接库</span></span><br><span class="line">        <span class="keyword">new</span> webpack.DllPlugin(&#123;</span><br><span class="line">            name: <span class="string">'react'</span>,</span><br><span class="line">            path: path.resolve(<span class="string">'dll'</span>, <span class="string">'manifest.json'</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">    ]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>代码写完了，npm run dll，之后会出现一个dll的文件夹，里面会包含你打包出来的文件</p>
<p><strong>引用动态链接库</strong><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="comment">// 引入webpack</span></span><br><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">'webpack'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    plugins: [</span><br><span class="line">        <span class="comment">// 引用对应的动态链接库的manifest.json文件</span></span><br><span class="line">        <span class="comment">// 这样以后再引入react的时候就会优先在json文件里去寻找</span></span><br><span class="line">        <span class="keyword">new</span> webpack.DllReferencePlugin(&#123;</span><br><span class="line">            manifest: path.resolve(<span class="string">'dll'</span>, <span class="string">'manifest.json'</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">    ]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>写到这里还不算完，还需要在src目录下的index.html模板中引入一下<br><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"../dll/react.dll.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>之所以，会新建一个dll目录，因为在npm start开发环境编译的时候，dist目录的内容都在内存中了，是找不到react.dll.js文件的</p>
<p><strong>动态引入js</strong><br>通过add-asset-html-webpack-plugin插件就可以完成这样的需求<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js文件</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">'webpack'</span>);</span><br><span class="line"><span class="comment">// 添加资源到html文件</span></span><br><span class="line"><span class="keyword">const</span> AddAssetHtmlWebpackPlugin = <span class="built_in">require</span>(<span class="string">'add-asset-html-webpack-plugin'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    plugins: [</span><br><span class="line">        <span class="comment">// 引用打包好的react，不会打包到bundle里</span></span><br><span class="line">        <span class="keyword">new</span> webpack.DllReferencePlugin(&#123;</span><br><span class="line">            manifest: path.resolve(<span class="string">'dll'</span>, <span class="string">'manifest.json'</span>)</span><br><span class="line">        &#125;),</span><br><span class="line">        <span class="comment">// 直接将打包好的react.dll.js添加到html模板</span></span><br><span class="line">        <span class="keyword">new</span> AddAssetHtmlWebpackPlugin(&#123;</span><br><span class="line">            filepath: path.resolve(<span class="string">'dll'</span>, <span class="string">'react.dll.js'</span>)</span><br><span class="line">        &#125;)</span><br><span class="line">    ]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<h3 id="懒加载"><a href="#懒加载" class="headerlink" title="懒加载"></a>懒加载</h3><p>说到懒加载必然是一种很好的优化网页或应用的方式，那么在webpack中也是通过ES6的import()语法来引入的。<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123; Component, Fragment &#125; <span class="keyword">from</span> <span class="string">"react"</span>;</span><br><span class="line"><span class="keyword">import</span> moment <span class="keyword">from</span> <span class="string">"moment"</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">"moment/locale/zh-cn"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置中文</span></span><br><span class="line"><span class="comment">// moment.locale("zh-cn");</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">List</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  btnClick = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">import</span>(<span class="string">"./test"</span>).then(<span class="function">(<span class="params">data</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(data);</span><br><span class="line">      data.a();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log($);</span><br><span class="line">    <span class="keyword">let</span> time = moment().format(<span class="string">"YYYY-MM-DD HH:mm:ss"</span>);</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;Fragment&gt;</span><br><span class="line">        &lt;div&gt;&#123;time&#125;&lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">        &lt;div&gt;111&lt;/</span>div&gt;</span><br><span class="line">        &lt;button onClick=&#123;<span class="keyword">this</span>.btnClick&#125;&gt;<span class="number">222</span>&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>Fragment&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="抽取公共代码"><a href="#抽取公共代码" class="headerlink" title="抽取公共代码"></a>抽取公共代码</h3><p>比如有两个js文件，一个是index.js另一个是lrc.js，它们都引用了著名的实用工具库lodash，代码如下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js文件</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> _ <span class="keyword">from</span> <span class="string">'lodash'</span>;</span><br><span class="line"><span class="built_in">console</span>.log(_.xor([<span class="number">2</span>, <span class="number">1</span>], [<span class="number">2</span>, <span class="number">3</span>]));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// lrc.js文件</span></span><br><span class="line"><span class="keyword">import</span> _ <span class="keyword">from</span> <span class="string">'lodash'</span>;</span><br><span class="line"><span class="built_in">console</span>.log(_.flatten([<span class="number">1</span>,[<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, [<span class="number">2</span>]]]));</span><br></pre></td></tr></table></figure>
<p><strong>抽取第三方模块</strong><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js文件</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    optimization: &#123;</span><br><span class="line">        splitChunks: &#123;</span><br><span class="line">            cacheGroups: &#123;</span><br><span class="line">                vendor: &#123;</span><br><span class="line">                    chunks: <span class="string">'initial'</span>,</span><br><span class="line">                    minSize: <span class="number">0</span>,</span><br><span class="line">                    minChunks: <span class="number">2</span>,</span><br><span class="line">                    test: <span class="regexp">/node_modules/</span>,</span><br><span class="line">                    priority: <span class="number">1</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p><strong>抽取公共模块</strong><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js文件</span></span><br><span class="line"><span class="keyword">import</span> &#123; flatten &#125; <span class="keyword">from</span> <span class="string">'./common'</span>;</span><br><span class="line"><span class="built_in">console</span>.log(<span class="string">'index'</span>,flatten([<span class="number">1</span>,[<span class="number">33</span>, <span class="number">4</span>, <span class="number">5</span>, [<span class="number">34</span>]]]));</span><br><span class="line"></span><br><span class="line"><span class="comment">// lrc.js文件</span></span><br><span class="line"><span class="keyword">import</span> &#123;flatten&#125; <span class="keyword">from</span> <span class="string">'./common'</span>;</span><br><span class="line"><span class="built_in">console</span>.log(flatten([<span class="number">1</span>,[<span class="number">33</span>, <span class="number">4</span>, <span class="number">5</span>, [<span class="number">34</span>]]]));</span><br></pre></td></tr></table></figure></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js文件</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    optimization: &#123;</span><br><span class="line">        splitChunks: &#123;</span><br><span class="line">            cacheGroups: &#123;</span><br><span class="line">                utils: &#123;</span><br><span class="line">                    chunks: <span class="string">'initial'</span>,</span><br><span class="line">                    minSize: <span class="number">0</span>,</span><br><span class="line">                    minChunks: <span class="number">2</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="IgnorePlugin"><a href="#IgnorePlugin" class="headerlink" title="IgnorePlugin"></a>IgnorePlugin</h3><p>作用： 忽略打包第三方模块指定的目录</p>
<p>为什么要忽略呢？ 通过下面的栗子来看一下</p>
<p>相信很多人应该或多或少的都听过moment这个时间库，不知道也没关系，我来演示一波</p>
<p>先安装moment： npm i moment -S</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 导入moment</span></span><br><span class="line"><span class="keyword">import</span> moment <span class="keyword">from</span> <span class="string">'moment'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置中文</span></span><br><span class="line">moment.locale(<span class="string">'zh-cn'</span>);</span><br><span class="line"><span class="keyword">let</span> time = moment().endOf(<span class="string">'day'</span>).fromNow();</span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>.root.innerHTML += time;</span><br></pre></td></tr></table></figure>
<p>页面上展示的一点毛病都没有，不过如果看一下打包的情况就会发现有瑕疵了</p>
<p>设置了中文，却把整个语言包都打包进去了，这样很不好</p>
<p>这是神马原因呢，其实是因为moment被导入的时候，附赠了整个locale语言包，这种买一赠一的行为就不用提现在代码世界了，吃不消了</p>
<p>我们需要用中文包，但是不想打包全部语言包，就让IgnorePlugin出马了<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js文件</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">'webpack'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    plugins: [</span><br><span class="line">        <span class="comment">// 忽略moment目录下的locale文件夹</span></span><br><span class="line">        <span class="keyword">new</span> webpack.IgnorePlugin(<span class="regexp">/\.\/locale/</span>, /moment/)</span><br><span class="line">    ]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></p>
<p>配置改写后，再回到index.js中单独导入中文语言包就好了<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.js文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 利用IgnorePlugin把只需要的语言包导入使用就可以了，省去了一下子打包整个语言包</span></span><br><span class="line"><span class="keyword">import</span> moment <span class="keyword">from</span> <span class="string">'moment'</span>;</span><br><span class="line"><span class="comment">// 单独导入中文语言包</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">'moment/locale/zh-cn'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> time = moment().endOf(<span class="string">'day'</span>).fromNow();</span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>.root.innerHTML += time;</span><br></pre></td></tr></table></figure></p>
<h3 id="noParse"><a href="#noParse" class="headerlink" title="noParse"></a>noParse</h3><p>noParse的作用是不去解析你所使用的第三方库中的依赖库</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    <span class="built_in">module</span>: &#123;</span><br><span class="line">        <span class="comment">// 不去解析jquery或lodash中的依赖库</span></span><br><span class="line">        noParse: <span class="regexp">/jquery|lodash/</span>,  </span><br><span class="line">        rules: [</span><br><span class="line">            &#123;</span><br><span class="line">                test: <span class="regexp">/\.js$/</span>,</span><br><span class="line">                use: &#123;</span><br><span class="line">                    loader: <span class="string">'babel-loader'</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在工作中，忽略大型的库可以提高构建性能，可以从构建时间上看出来速度的提升，如上面代码中提到的jquery和lodash</p>
<h3 id="resolve"><a href="#resolve" class="headerlink" title="resolve"></a>resolve</h3><p>从这个英文就能看出来，它就是配置模块如何解析用的，配置太多也没必要一一介绍了，还是直接说重点写出常用的配置吧</p>
<p><strong>resolve常用配置</strong></p>
<ol>
<li>modules<ol>
<li>指定解析第三方包的目录位置</li>
</ol>
</li>
<li>alias<ol>
<li>指定import导入时的别名，简化引入</li>
</ol>
</li>
<li>extensions<ol>
<li>自动解析确定好的扩展名</li>
<li>默认会把js和json当做扩展名</li>
</ol>
</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; resolve &#125; = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    resolve: &#123;</span><br><span class="line">        modules: [resolve(<span class="string">'node_modules'</span>)],</span><br><span class="line">        alias: &#123;</span><br><span class="line">            Utils: resolve(__dirname, <span class="string">'src/utils/'</span>),</span><br><span class="line">            <span class="string">'@'</span>: resolve(__dirname, <span class="string">'src'</span>)</span><br><span class="line">        &#125;,</span><br><span class="line">        extensions: [<span class="string">'.js'</span>, <span class="string">'.css'</span>, <span class="string">'.json'</span>]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="include和exclude"><a href="#include和exclude" class="headerlink" title="include和exclude"></a>include和exclude</h3><ol>
<li>include: 包含指定目录下的文件解析</li>
<li>exclude: 排除指定目录不进行解析</li>
</ol>
<p>二者使用一个即可了</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    <span class="built_in">module</span>: &#123;</span><br><span class="line">        rules: [</span><br><span class="line">            &#123;</span><br><span class="line">                test: <span class="regexp">/\.js$/</span>,</span><br><span class="line">                use: &#123;</span><br><span class="line">                    loader: <span class="string">'babel-loader'</span></span><br><span class="line">                &#125;,</span><br><span class="line">                exculde: <span class="regexp">/node_modules/</span>,    <span class="comment">// 二选一</span></span><br><span class="line">                include: path.resolve(<span class="string">'src'</span>)    <span class="comment">// 二选一</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="happypack"><a href="#happypack" class="headerlink" title="happypack"></a>happypack</h3><p>webpack在Node环境下运行所以也是单线程操作，一件一件的去处理事情。<br>于是乎，就有了happypack的用武之地了，它的作用就是可以实现多进程打包操作</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.config.js文件</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Happypack = <span class="built_in">require</span>(<span class="string">'happypack'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">    <span class="built_in">module</span>: &#123;</span><br><span class="line">        rules: [</span><br><span class="line">            &#123;</span><br><span class="line">                test: <span class="regexp">/\.js$/</span>,</span><br><span class="line">                use: <span class="string">'Happypack/loader?id=js'</span></span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                test: <span class="regexp">/\.css$/</span>,</span><br><span class="line">                use: <span class="string">'Happypack/loader?id=css'</span></span><br><span class="line">            &#125;</span><br><span class="line">        ]</span><br><span class="line">    &#125;,</span><br><span class="line">    plugins: [</span><br><span class="line">        <span class="keyword">new</span> Happypack(&#123;</span><br><span class="line">            id: <span class="string">'js'</span>,</span><br><span class="line">            loaders: [</span><br><span class="line">                &#123;</span><br><span class="line">                    loader: <span class="string">'babel-loader'</span>,</span><br><span class="line">                    options: &#123;</span><br><span class="line">                        presets: [</span><br><span class="line">                            <span class="string">'@babel/preset-env'</span>,</span><br><span class="line">                            <span class="string">'@babel/preset-react'</span></span><br><span class="line">                        ]</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;),</span><br><span class="line">        <span class="keyword">new</span> Happypack(&#123;</span><br><span class="line">            id: <span class="string">'css'</span>,</span><br><span class="line">            loaders: [<span class="string">'style-loader'</span>, <span class="string">'css-loader'</span>]</span><br><span class="line">        &#125;)</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于HappyPack 对file-loader、url-loader 支持的不友好，所以不建议对该loader使用。</p>
<p><strong>HappyPack 参数</strong></p>
<ol>
<li><strong>id</strong>: String 用唯一的标识符 id 来代表当前的 HappyPack 是用来处理一类特定的文件.</li>
<li><strong>loaders</strong>: Array 用法和 webpack Loader 配置中一样.</li>
<li><strong>threads</strong>: Number 代表开启几个子进程去处理这一类型的文件，默认是3个，类型必须是整数。</li>
<li><strong>verbose</strong>: Boolean 是否允许 HappyPack 输出日志，默认是 true。</li>
<li><strong>threadPool:</strong> HappyThreadPool 代表共享进程池，即多个 HappyPack 实例都使用同一个共享进程池中的子进程去处理任务，以防止资源占用过多。</li>
<li><strong>verboseWhenProfiling</strong>: Boolean 开启webpack –profile ,仍然希望HappyPack产生输出。</li>
<li><strong>debug</strong>: Boolean 启用debug 用于故障排查。默认 false。</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/12/js设计模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="AmamiRyoin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/headImg/head_Img.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="AmamiRyoin's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/07/12/js设计模式/" itemprop="url">JS中的设计模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-07-12T21:51:05+08:00">
                2020-07-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在程序设计中有很多实用的设计模式，而其中大部分语言的实现都是基于“类”。</p>
<p>在JavaScript中并没有类这种概念，JS中的函数属于一等对象，在JS中定义一个对象非常简单（var obj = {}），而基于JS中闭包与弱类型等特性，在实现一些设计模式的方式上与众不同。</p>
<p>本文参照了《JavaScript 设计模式》一书，做了一些总结和个人理解。</p>
<h3 id="设计原则"><a href="#设计原则" class="headerlink" title="设计原则"></a>设计原则</h3><h4 id="单一职责原则（SRP）"><a href="#单一职责原则（SRP）" class="headerlink" title="单一职责原则（SRP）"></a>单一职责原则（SRP）</h4><p>一个对象或方法只做一件事情。如果一个方法承担了过多的职责，那么在需求的变迁过程中，需要改写这个方法的可能性就越大。应该把对象或方法划分成较小的粒度。</p>
<h4 id="最少知识原则（LKP）"><a href="#最少知识原则（LKP）" class="headerlink" title="最少知识原则（LKP）"></a>最少知识原则（LKP）</h4><p>一个软件实体应当 尽可能少地与其他实体发生相互作用。<br>应当尽量减少对象之间的交互。如果两个对象之间不必彼此直接通信，那么这两个对象就不要发生直接的 相互联系，可以转交给第三方进行处理。</p>
<h4 id="开放-封闭原则（OCP）"><a href="#开放-封闭原则（OCP）" class="headerlink" title="开放-封闭原则（OCP）"></a>开放-封闭原则（OCP）</h4><p>软件实体（类、模块、函数）等应该是可以扩展的，但是不可修改。<br>当需要改变一个程序的功能或者给这个程序增加新功能的时候，可以使用增加代码的方式，尽量避免改动程序的源代码，防止影响原系统的稳定。</p>
<h3 id="什么是设计模式"><a href="#什么是设计模式" class="headerlink" title="什么是设计模式"></a>什么是设计模式</h3><p>这里有个很好的比喻。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">假设有一个空房间，我们要日复一日地往里 面放一些东西。最简单的办法当然是把这些东西 直接扔进去，但是时间久了，就会发现很难从这 个房子里找到自己想要的东西，要调整某几样东 西的位置也不容易。所以在房间里做一些柜子也 许是个更好的选择，虽然柜子会增加我们的成 本，但它可以在维护阶段为我们带来好处。使用 这些柜子存放东西的规则，或许就是一种模式。</span><br></pre></td></tr></table></figure></p>
<p>设计模式的原则是“找出 程序中变化的地方，并将变化封装起来”，它的关键是意图，而不是结构。</p>
<h3 id="几种设计模式"><a href="#几种设计模式" class="headerlink" title="几种设计模式"></a>几种设计模式</h3><h4 id="构造器模式"><a href="#构造器模式" class="headerlink" title="构造器模式"></a>构造器模式</h4><ul>
<li>定义<br>在面向对象编程中，构造器是一个当新建对象的内存被分配后，用来初始化该对象的一个特殊函数。<br>对象构造器是被用来创建特殊类型的对象的，首先它要准备使用的对象，其次在对象初次被创建时，通过接收参数，构造器要用来对成员的属性和方法进行赋值。<br>Javascript不支持类的概念，但它有一种与对象一起工作的构造器函数。使用new关键字来调用该函数，我们可以告诉Javascript把这个函数当做一个构造器来用,它可以用自己所定义的成员来初始化一个对象。构造器内部，关键字this引用到刚被创建的对象。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">function mataChuan( name, age, identity ) &#123;</span><br><span class="line"></span><br><span class="line">  this.name = name;</span><br><span class="line">  this.age = age;</span><br><span class="line">  this.identity = identity;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mataChuan.prototype.bearingRight = function () &#123;</span><br><span class="line">  return &apos;你是不是个龙鸣&apos;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// 我们可以示例化一个mataChuan</span><br><span class="line">var mataChuan = new mataChuan( &quot;mataChuan&quot;, 30, &apos;日本新津天皇&apos; );</span><br></pre></td></tr></table></figure>
<h4 id="单例模式"><a href="#单例模式" class="headerlink" title="单例模式"></a>单例模式</h4><ul>
<li>定义<br>保证一个类仅有一个实例，并提供一个访问它的全局访问点。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">function SetMataChuan(name) &#123;</span><br><span class="line">    this.name = name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SetMataChuan.prototype.getName = function() &#123;</span><br><span class="line">    console.log(this.name);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">// 提取出通用的单例</span><br><span class="line">function getSingle(fn) &#123;</span><br><span class="line">    var instance = null;</span><br><span class="line">    return function() &#123;</span><br><span class="line">        if (!instance) &#123;</span><br><span class="line">            instance = fn.apply(this, arguments);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return instance;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">let SingleSetMataChuan = getSingle(function(name)&#123;</span><br><span class="line">    let mataChuan = new SetMataChuan(name);</span><br><span class="line">    return mataChuan.getName()</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">SingleSetMataChuan(&apos;mataChuan&apos;); // mataChuan</span><br></pre></td></tr></table></figure>
<h4 id="工厂模式"><a href="#工厂模式" class="headerlink" title="工厂模式"></a>工厂模式</h4><ul>
<li>定义<br>工厂模式是一种关注对象创建概念的创建模式。它的领域中同其它模式的不同之处在于它并没有明确要求我们使用一个构造器。取而代之，一个工厂能提供一个创建对象的公共接口，我们可以在其中指定我们希望被创建的工厂对象的类型。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">var mataChuan  = function()&#123;</span><br><span class="line">    this.nickName = &apos;带带大师兄&apos;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">mataChuan.prototype  = &#123;</span><br><span class="line">    getGuoji :function()&#123;</span><br><span class="line">        console.log(&apos;我是日本人，来中国留学好久了&apos;);</span><br><span class="line">    &#125;,</span><br><span class="line">    getSkill:function()&#123;</span><br><span class="line">        console.log(&apos;-8000&apos;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var Dingxiaoxiao = function()&#123;</span><br><span class="line">    this.name = &apos;丁潇潇&apos;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Dingxiaoxiao.prototype = &#123;</span><br><span class="line">    callMataChuan :function()&#123;</span><br><span class="line">        console.log(&apos;mataChuan我们双流机场见一面&apos;);</span><br><span class="line">    &#125;,</span><br><span class="line">    getSkill:function()&#123;</span><br><span class="line">        console.log(&apos;+8000&apos;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var factory = function(type)&#123;</span><br><span class="line">    switch(type)&#123;</span><br><span class="line">        case &apos;Dingxiaoxiao&apos;: return new Dingxiaoxiao();</span><br><span class="line">        case &apos;mataChuan&apos;: return new mataChuan();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//然后我们就可以这么用</span><br><span class="line">var mataChuan = factory(&apos;mataChuan&apos;);</span><br><span class="line">var Dingxiaoxiao = factory(&apos;Dingxiaoxiao&apos;);</span><br><span class="line">mataChuan.getGuoji();</span><br><span class="line">Dingxiaoxiao.callMataChuan();</span><br><span class="line">mataChuan.getSkill();</span><br><span class="line">Dingxiaoxiao.getSkill();</span><br></pre></td></tr></table></figure>
<h4 id="策略模式"><a href="#策略模式" class="headerlink" title="策略模式"></a>策略模式</h4><ul>
<li>定义<br>定义一系列的算法，把它们一个个封装起来，并且使它们可以相互替换，从而避免很多if语句</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">let mataChuanSkills = &#123;</span><br><span class="line">    &quot;恰烂钱&quot;: function(money) &#123;</span><br><span class="line">        return money * 2;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;网恋&quot; : function(money) &#123;</span><br><span class="line">        return money-8000;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;和深海哥打招呼&quot; : function(money) &#123;</span><br><span class="line">        return money * 20;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line">let mataChuanAction =function(type,money) &#123;</span><br><span class="line">    return obj[type](money);</span><br><span class="line">&#125;;</span><br><span class="line">console.log(mataChuanAction(&apos;网恋&apos;,8000)); // 0</span><br></pre></td></tr></table></figure>
<h4 id="代理模式"><a href="#代理模式" class="headerlink" title="代理模式"></a>代理模式</h4><ul>
<li>定义<br>为一个对象提供一个代用品或占位符，以便控制对它的访问。代理模式主要有三种：保护代理、虚拟代理、缓存代理。</li>
</ul>
<p>保护代理主要实现了访问主体的限制行为，以过滤字符作为简单的例子。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">// 主体，发送消息</span><br><span class="line">function sendMsg(msg) &#123;</span><br><span class="line">    console.log(msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 代理，对消息进行过滤</span><br><span class="line">function proxySendMsg(msg) &#123;</span><br><span class="line">    // 无消息则直接返回</span><br><span class="line">    if (typeof msg === &apos;undefined&apos;) &#123;</span><br><span class="line">        console.log(&apos;好久不见深海哥&apos;);</span><br><span class="line">        return;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    // 有消息则进行过滤</span><br><span class="line">    msg = msg.replace(/龙鸣给爷爬/g, &apos;你好&apos;);</span><br><span class="line"></span><br><span class="line">    sendMsg(msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sendMsg(&apos;龙鸣给爷爬，XXX&apos;); // 龙鸣给爷爬，XXX</span><br><span class="line">proxySendMsg(&apos;龙鸣给爷爬，XXX&apos;); // 你好，XXX</span><br><span class="line">proxySendMsg(); // 好久不见深海哥</span><br><span class="line">//在访问主体之前进行控制，没有消息的时候直接在代理中返回了，拒绝访问主体</span><br></pre></td></tr></table></figure>
<p>缓存代理可以为一些开销大的运算结果提供暂时的缓存，提升效率。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">// 主体</span><br><span class="line">function addGeng() &#123;</span><br><span class="line">    var gengs = [].slice.call(arguments).join(&apos;,&apos;);</span><br><span class="line">    return gengs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 代理</span><br><span class="line">var proxyAddGeng = (function() &#123;</span><br><span class="line">    var oldGengs = &apos;&apos;;</span><br><span class="line">    return function() &#123;</span><br><span class="line">        var gengs = [].slice.call(arguments).join(&apos;,&apos;);</span><br><span class="line">        // 如果有，则直接从缓存返回</span><br><span class="line">        if (oldGengs.indexOf(gengs)&gt;-1) &#123;</span><br><span class="line">            console.log(&apos;已有梗&apos;,gengs)</span><br><span class="line">            return oldGengs;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            oldGengs+=addGeng.apply(this, arguments); </span><br><span class="line">            return oldGengs;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line">console.log(</span><br><span class="line">    proxyAddGeng(&apos;爬&apos;,&apos;龙鸣&apos;),</span><br><span class="line">    proxyAddGeng(&apos;爬&apos;,&apos;龙鸣&apos;)</span><br><span class="line">);</span><br></pre></td></tr></table></figure></p>
<p>虚拟代理在控制对主体的访问时，加入了一些额外的操作。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">var mataChuan = function(name)&#123;</span><br><span class="line">    this.name = name;</span><br><span class="line">&#125;</span><br><span class="line">//隐藏复杂，不愿意修改的的方法</span><br><span class="line">var dogFans = function(mataChuan)&#123;</span><br><span class="line">    this.mataChuan = mataChuan;</span><br><span class="line">    this.send = function(fakeMsg)&#123;</span><br><span class="line">        console.log(fakeMsg+&apos;@&apos;+this.mataChuan.name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">var weibo = function(targetMan)&#123;</span><br><span class="line">    this.send = function(fakeMsg)&#123;</span><br><span class="line">        new dogFans(targetMan).send(fakeMsg);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">var weibo = new weibo(new mataChuan(&quot;mata川&quot;));</span><br><span class="line">weibo.send(&quot;用激光笔照射坤坤的凶手找到了&quot;);</span><br><span class="line">weibo.send(&quot;火烧明尼苏达烂尾楼的凶手找到了&quot;);</span><br></pre></td></tr></table></figure></p>
<h4 id="装饰者模式"><a href="#装饰者模式" class="headerlink" title="装饰者模式"></a>装饰者模式</h4><ul>
<li>定义<br>以动态地给某个对象添加一些额外的职责，而不会影响从这个类中派生的其他对象。<br>是一种“即用即付”的方式，能够在不改变对 象自身的基础上，在程序运行期间给对象动态地 添加职责。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">// 装饰器，在当前函数执行前先执行另一个函数</span><br><span class="line">function decoratorBefore(fn, beforeFn) &#123;</span><br><span class="line">    return function() &#123;</span><br><span class="line">        var ret = beforeFn.apply(this, arguments);</span><br><span class="line">        </span><br><span class="line">        // 在前一个函数中判断，不需要执行当前函数</span><br><span class="line">        if (ret !== false) &#123;</span><br><span class="line">            fn.apply(this, arguments);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">function netKoi() &#123;</span><br><span class="line">    console.log(&apos;网恋&apos;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function buyTicket() &#123;</span><br><span class="line">    console.log(&apos;买机票&apos;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function driveCar() &#123;</span><br><span class="line">    console.log(&apos;开车&apos;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function screwed()&#123;</span><br><span class="line">    console.log(&apos;被骗-8000&apos;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">var skillDecorator = decoratorBefore(screwed, buyTicket);</span><br><span class="line">skillDecorator = decoratorBefore(skillDecorator, driveCar);</span><br><span class="line">skillDecorator = decoratorBefore(skillDecorator, netKoi);</span><br><span class="line"></span><br><span class="line">skillDecorator(); // 跑步 音乐 数学</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="命令模式"><a href="#命令模式" class="headerlink" title="命令模式"></a>命令模式</h4><ul>
<li>定义<br>用一种松耦合的方式来设计程序，使得请求发送者和请求接收者能够消除彼此之间的耦合关系。<br>命名模式的目标是将方法的调用,请求或者操作封装到一个单独的对象中,给我们酌情执行同时参数化和传递方法调用的能力.另外,它使得我们能将对象从实现了行为的对象对这些行为的调用进行解耦,为我们带来了换出具体的对象这一更深程度的整体灵活性。<br>实现明智简单的命令对象,将一个行为和对象对调用这个行为的需求都绑定到了一起.它们始终都包含一个执行操作(比如run()或者execute()).所有带有相同接口的命令对象能够被简单地根据需要调换,这被认为是命令模式的更大的好处之一。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">var CarManager = &#123;</span><br><span class="line"></span><br><span class="line">    // request information</span><br><span class="line">    requestInfo: function( model, id )&#123;</span><br><span class="line">        return &quot;The information for &quot; + model + &quot; with ID &quot; + id + &quot; is foobar&quot;;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    // purchase the car</span><br><span class="line">    buyVehicle: function( model, id )&#123;</span><br><span class="line">        return &quot;You have successfully purchased Item &quot; + id + &quot;, a &quot; + model;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    // arrange a viewing</span><br><span class="line">    arrangeViewing: function( model, id )&#123;</span><br><span class="line">        return &quot;You have successfully booked a viewing of &quot; + model + &quot; ( &quot; + id + &quot; ) &quot;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line">CarManager.execute = function ( name ) &#123;</span><br><span class="line">    return CarManager[name] &amp;&amp; CarManager[name].apply( CarManager, [].slice.call(arguments, 1) );</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">CarManager.execute( &quot;arrangeViewing&quot;, &quot;Ferrari&quot;, &quot;14523&quot; );</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/05/22/pupeteer/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="AmamiRyoin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/headImg/head_Img.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="AmamiRyoin's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/05/22/pupeteer/" itemprop="url">puppeteer浅谈</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-05-22T20:37:25+08:00">
                2020-05-22
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="puppeteer浅谈"><a href="#puppeteer浅谈" class="headerlink" title="puppeteer浅谈"></a>puppeteer浅谈</h2><h3 id="Puppeteer-是什么"><a href="#Puppeteer-是什么" class="headerlink" title="Puppeteer 是什么"></a>Puppeteer 是什么</h3><ul>
<li>Puppeteer 是 Node.js 工具引擎</li>
<li>Puppeteer 提供了一系列 API，通过 Chrome DevTools Protocol 协议控制 Chromium/Chrome 浏览器的行为</li>
<li>Puppeteer 默认情况下是以 headless 启动 Chrome 的，也可以通过参数控制启动有界面的 Chrome</li>
<li>Puppeteer 默认绑定最新的 Chromium 版本，也可以自己设置不同版本的绑定</li>
<li>Puppeteer 让我们不需要了解太多的底层 CDP 协议实现与浏览器的通信</li>
</ul>
<h3 id="Puppeteer-能做什么"><a href="#Puppeteer-能做什么" class="headerlink" title="Puppeteer 能做什么"></a>Puppeteer 能做什么</h3><ul>
<li>网页截图或者生成 PDF</li>
<li>爬取 SPA 或 SSR 网站</li>
<li>UI 自动化测试，模拟表单提交，键盘输入，点击等行为</li>
<li>捕获网站的时间线，帮助诊断性能问题</li>
<li>创建一个最新的自动化测试环境，使用最新的 js 和最新的 Chrome 浏览器运行测试用例</li>
<li>测试 Chrome 扩展程序</li>
</ul>
<h3 id="Puppeteer常用类"><a href="#Puppeteer常用类" class="headerlink" title="Puppeteer常用类"></a>Puppeteer常用类</h3><ul>
<li>Browser： 对应一个浏览器实例，一个 Browser 可以包含多个 BrowserContext</li>
<li>BrowserContext： 对应浏览器一个上下文会话，就像我们打开一个普通的 Chrome 之后又打开一个隐身模式的浏览器一样，BrowserContext 具有独立的 Session(cookie 和 cache 独立不共享)，一个 BrowserContext 可以包含多个 Page</li>
<li>Page：表示一个 Tab 页面，通过 browserContext.newPage()/browser.newPage() 创建，browser.newPage() 创建页面时会使用默认的 BrowserContext，一个 Page 可以包含多个 Frame</li>
<li>Frame: 一个框架，每个页面有一个主框架（page.MainFrame()）,也可以多个子框架，主要由 iframe 标签创建产生的</li>
<li>ExecutionContext： 是 javascript 的执行环境，每一个 Frame 都一个默认的 javascript 执行环境</li>
<li>ElementHandle: 对应 DOM 的一个元素节点，通过该该实例可以实现对元素的点击，填写表单等行为，我们可以通过选择器，xPath 等来获取对应的元素</li>
<li>JsHandle：对应 DOM 中的 javascript 对象，ElementHandle 继承于 JsHandle，由于我们无法直接操作 DOM 中对象，所以封装成 JsHandle 来实现相关功能</li>
<li>CDPSession：可以直接与原生的 CDP 进行通信，通过 session.send 函数直接发消息，通过 session.on 接收消息，可以实现 Puppeteer API 中没有涉及的功能</li>
<li>Coverage：获取 JavaScript 和 CSS 代码覆盖率</li>
<li>Tracing：抓取性能数据进行分析</li>
<li>Response： 页面收到的响应</li>
<li>Request： 页面发出的请求</li>
</ul>
<h4 id="创建一个-Browser-实例"><a href="#创建一个-Browser-实例" class="headerlink" title="创建一个 Browser 实例"></a>创建一个 Browser 实例</h4><p><code>puppeteer.launch</code>: 每次都启动一个 Chrome 实例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">const puppeteer = require(&apos;puppeteer&apos;);</span><br><span class="line">let request = require(&apos;request-promise-native&apos;);</span><br><span class="line"></span><br><span class="line">//使用 puppeteer.launch 启动 Chrome</span><br><span class="line">(async () =&gt; &#123;</span><br><span class="line">    const browser = await puppeteer.launch(&#123;</span><br><span class="line">        headless: false,   //有浏览器界面启动</span><br><span class="line">        slowMo: 100,       //放慢浏览器执行速度，方便测试观察</span><br><span class="line">        args: [            //启动 Chrome 的参数，详见上文中的介绍</span><br><span class="line">            &apos;–no-sandbox&apos;,</span><br><span class="line">            &apos;--window-size=1280,960&apos;</span><br><span class="line">        ],</span><br><span class="line">    &#125;);</span><br><span class="line">    const page = await browser.newPage();</span><br><span class="line">    await page.goto(&apos;https://www.baidu.com&apos;);</span><br><span class="line">    await page.close();</span><br><span class="line">    await browser.close();</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure></p>
<h4 id="等待元素、请求、响应"><a href="#等待元素、请求、响应" class="headerlink" title="等待元素、请求、响应"></a>等待元素、请求、响应</h4><ul>
<li>page.waitForXPath：等待 xPath 对应的元素出现，返回对应的 ElementHandle 实例</li>
<li>page.waitForSelector ：等待选择器对应的元素出现，返回对应的 ElementHandle 实例</li>
<li>page.waitForResponse ：等待某个响应结束，返回 Response 实例</li>
<li>page.waitForRequest：等待某个请求出现，返回 Request 实例</li>
<li>page.waitForFunction：等待在页面中自定义函数的执行结果，返回 JsHandle 实例</li>
<li>page.waitFor：设置等待时间，实在没办法的做法</li>
</ul>
<h3 id="具体用例"><a href="#具体用例" class="headerlink" title="具体用例"></a>具体用例</h3><h4 id="截图"><a href="#截图" class="headerlink" title="截图"></a>截图</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">(async () =&gt; &#123;</span><br><span class="line">  const browser = await puppeteer.launch();</span><br><span class="line">  const page = await browser.newPage();</span><br><span class="line">  //设置可视区域大小</span><br><span class="line">  await page.setViewport(&#123;width: 1920, height: 800&#125;);</span><br><span class="line">  await page.goto(&apos;https://www.baidu.com/&apos;);</span><br><span class="line">  //对整个页面截图</span><br><span class="line">  await page.screenshot(&#123;</span><br><span class="line">      path: &apos;./capture.png&apos;,  //图片保存路径</span><br><span class="line">      type: &apos;png&apos;,</span><br><span class="line">      fullPage: true //边滚动边截图</span><br><span class="line">      // clip: &#123;x: 0, y: 0, width: 1920, height: 800&#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  //对页面某个元素截图</span><br><span class="line">  let [element] = await page.$x(&apos;/html/body/div/div[1]/div[5]&apos;);</span><br><span class="line">  await element.screenshot(&#123;</span><br><span class="line">      path: &apos;./element.png&apos;</span><br><span class="line">  &#125;);</span><br><span class="line">  await page.close();</span><br><span class="line">  await browser.close();</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<h4 id="模拟用户登录"><a href="#模拟用户登录" class="headerlink" title="模拟用户登录"></a>模拟用户登录</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">(async () =&gt; &#123;</span><br><span class="line">    const browser = await puppeteer.launch(&#123;</span><br><span class="line">        slowMo: 100,    //放慢速度</span><br><span class="line">        headless: false,</span><br><span class="line">        defaultViewport: &#123;width: 1440, height: 780&#125;,</span><br><span class="line">        ignoreHTTPSErrors: false, //忽略 https 报错</span><br><span class="line">        args: [&apos;--start-fullscreen&apos;] //全屏打开页面</span><br><span class="line">    &#125;);</span><br><span class="line">    const page = await browser.newPage();</span><br><span class="line">    await page.goto(&apos;https://passport.bilibili.com/login&apos;);</span><br><span class="line">    //输入账号密码</span><br><span class="line">    const uniqueIdElement = await page.$(&apos;#uniqueId&apos;);</span><br><span class="line">    await uniqueIdElement.type(&apos;admin@admin.com&apos;, &#123;delay: 20&#125;);</span><br><span class="line">    const passwordElement = await page.$(&apos;#password&apos;, &#123;delay: 20&#125;);</span><br><span class="line">    await passwordElement.type(&apos;123456&apos;);</span><br><span class="line">    //点击确定按钮进行登录</span><br><span class="line">    let okButtonElement = await page.$(&apos;#btn-ok&apos;);</span><br><span class="line">    //等待页面跳转完成，一般点击某个按钮需要跳转时，都需要等待 page.waitForNavigation() 执行完毕才表示跳转成功</span><br><span class="line">    await Promise.all([</span><br><span class="line">        okButtonElement.click(),</span><br><span class="line">        page.waitForNavigation()  </span><br><span class="line">    ]);</span><br><span class="line">    console.log(&apos;admin 登录成功&apos;);</span><br><span class="line">    await page.close();</span><br><span class="line">    await browser.close();</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<h4 id="请求拦截"><a href="#请求拦截" class="headerlink" title="请求拦截"></a>请求拦截</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">(async () =&gt; &#123;</span><br><span class="line">    const browser = await puppeteer.launch();</span><br><span class="line">    const page = await browser.newPage();</span><br><span class="line">    await page.setRequestInterception(true); //开启请求拦截</span><br><span class="line">    page.on(&apos;request&apos;, request =&gt; &#123;</span><br><span class="line">        const method = request._method;</span><br><span class="line">        if(method)&#123;</span><br><span class="line">            //直接阻止请求</span><br><span class="line">            return request.abort();</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            //对请求重写</span><br><span class="line">            return request.continue(&#123;</span><br><span class="line">                //可以对 url，method，postData，headers 进行覆盖</span><br><span class="line">                headers: Object.assign(&#123;&#125;, request.headers(), &#123;</span><br><span class="line">                    &apos;puppeteer-test&apos;: &apos;true&apos;</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    await page.goto(&apos;https://www.bilibili.com/&apos;);</span><br><span class="line">    await page.close();</span><br><span class="line">    await browser.close();</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<h4 id="植入-javascript-代码"><a href="#植入-javascript-代码" class="headerlink" title="植入 javascript 代码"></a>植入 javascript 代码</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">(async () =&gt; &#123;</span><br><span class="line">    const browser = await puppeteer.launch();</span><br><span class="line">    const page = await browser.newPage();</span><br><span class="line">    await page.goto(&apos;https://www.bilibili.com/&apos;);</span><br><span class="line">    //注册一个 Node.js 函数，在浏览器里运行</span><br><span class="line">    //通过 page.evaluate 在浏览器里执行代码</span><br><span class="line">    await page.evaluate(async () =&gt;  &#123;</span><br><span class="line">        setTimeout(()=&gt;&#123;</span><br><span class="line">            document.querySelector(&apos;.logout-face&apos;).src=&apos;https://ss0.bdstatic.com/70cFvHSh_Q1YnxGkpoWK1HF6hhy/it/u=185623326,2667787122&amp;fm=26&amp;gp=0.jpg&apos;;</span><br><span class="line">            document.querySelector(&apos;#van-popover-9482&apos;).innerHTML=&apos;全是我干的&apos;；</span><br><span class="line">        &#125;,3000)</span><br><span class="line">    &#125;);</span><br><span class="line">    await page.close();</span><br><span class="line">    await browser.close();</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<h4 id="模拟不同的设备"><a href="#模拟不同的设备" class="headerlink" title="模拟不同的设备"></a>模拟不同的设备</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">const puppeteer = require(&apos;puppeteer&apos;);</span><br><span class="line">const iPhone = puppeteer.devices[&apos;iPhone X&apos;];</span><br><span class="line">puppeteer.launch(&#123;</span><br><span class="line">  headless:false</span><br><span class="line">&#125;).then(async browser =&gt; &#123;</span><br><span class="line">  const page = await browser.newPage();</span><br><span class="line">  await page.emulate(iPhone);</span><br><span class="line">  await page.goto(&apos;https://www.bilibili.com/&apos;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/24/换肤/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="AmamiRyoin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/headImg/head_Img.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="AmamiRyoin's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/24/换肤/" itemprop="url">换肤</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-02-24T19:28:19+08:00">
                2020-02-24
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="使用前的准备"><a href="#使用前的准备" class="headerlink" title="使用前的准备"></a>使用前的准备</h3><ul>
<li><p>安装 antd-theme-generator (color.js脚本中使用该库进行打包)</p>
</li>
<li><p>安装 postcss-css-variables （考虑var()兼容性）</p>
</li>
<li><p>html模板中引入less.js库，并设置less配置项，引入新增的less文件<br></p>
</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--在线编译的less文件 --&gt;</span><br><span class="line">&lt;link rel=&quot;stylesheet/less&quot; type=&quot;text/css&quot; href=&quot;/assets/color.less&quot; /&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    &lt;!--less配置项--&gt;</span><br><span class="line">    window.less = &#123;</span><br><span class="line">        async: false, // 同步加载的方式引入</span><br><span class="line">        env: &apos;production&apos; // 生产环境不打log 不报错，数据存入localstorage中</span><br><span class="line">    &#125;;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;script src=&quot;https://cdn.bootcss.com/less.js/2.7.2/less.min.js&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<h3 id="使用中的步骤"><a href="#使用中的步骤" class="headerlink" title="使用中的步骤"></a>使用中的步骤</h3><ul>
<li>项目目录下新建color.js文件，修改package.json中脚本命令，在执行前先node color &amp;&amp; yarn start<br></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">const path = require(&apos;path&apos;);</span><br><span class="line">const &#123;generateTheme&#125; = require(&apos;antd-theme-generator&apos;);</span><br><span class="line"></span><br><span class="line">const options = &#123;</span><br><span class="line">    stylesDir: path.join(__dirname, &apos;./src/assets/less&apos;),</span><br><span class="line">    antDir: path.join(__dirname, &apos;./node_modules/antd&apos;),</span><br><span class="line">    varFile: path.join(__dirname, &apos;./src/assets/less/vars.less&apos;),</span><br><span class="line">    mainLessFile: path.join(__dirname, &apos;./src/assets/less/main.less&apos;),</span><br><span class="line">    themeVariables: [</span><br><span class="line">        &apos;@primary-color&apos;,</span><br><span class="line">        &apos;@btnActiveColor&apos;</span><br><span class="line">    ],</span><br><span class="line">    outputFilePath: path.join(__dirname, &apos;./public/assets/color.less&apos;),</span><br><span class="line">    customColorRegexArray: [/^darken\(.*\)$/]</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">generateTheme(options)</span><br><span class="line">    .then(less =&gt; &#123;</span><br><span class="line">        console.log(&apos;Theme generated successfully&apos;);</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(error =&gt; &#123;</span><br><span class="line">        console.log(&apos;Error&apos;, error);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>
<ul>
<li>新增一个css变量需要以下四步（如果不需要考虑兼容性，步骤2和3可以省略）</li>
</ul>
<ol>
<li><p>在color.js的themeVariables数组中添加less变量名<code>@btnColor</code>（未在此处申明的变量后面是无法通过modifyVars修改变量值的）</p>
</li>
<li><p>在vars.less中添加less变量的初始值<code>@btnColor:#fffffe</code>后，在<code>:root{}</code>中设置同名css变量并赋值<code>--btnColor: @btnColor</code><br></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// 引入antd主题文件</span><br><span class="line">@import &apos;~antd/lib/style/themes/default.less&apos;;</span><br><span class="line"></span><br><span class="line">// 改写antd默认变量值</span><br><span class="line">@primary-color: #ffc847;</span><br><span class="line">// 添加自定义变量</span><br><span class="line">@btnActiveColor: #fffffe;</span><br><span class="line"></span><br><span class="line">// 搭配css变量，控制非antd组件的样式</span><br><span class="line">:root &#123;</span><br><span class="line">  --primary: @primary-color;</span><br><span class="line">  --btnActiveColor: @btnActiveColor;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在<code>cssVariabelConfig.js</code>文件中，配置css变量的默认值（用于webpack打包时，生成兼容不支持css变量的环境）<br></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">// cssVariabelConfig.js</span><br><span class="line">module.exports = &#123;</span><br><span class="line">    &apos;--primary-color&apos;: &quot;#ffc847&quot;,</span><br><span class="line">    &apos;--btnActiveColor&apos;: &apos;#fffffe&apos;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// webpack</span><br><span class="line">const cssvariables = require(&apos;postcss-css-variables&apos;);</span><br><span class="line">const cssVariablesConfig = require(&apos;./theme/cssVariabelConfig&apos;)</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    test: /\.less$/,</span><br><span class="line">    use: [</span><br><span class="line">      require.resolve(&apos;style-loader&apos;),</span><br><span class="line">      require.resolve(&apos;css-loader&apos;), &#123;</span><br><span class="line">        loader: require.resolve(&apos;postcss-loader&apos;),</span><br><span class="line">        options: &#123;</span><br><span class="line">          ident: &apos;postcss&apos;,</span><br><span class="line">          plugins: () =&gt; [</span><br><span class="line">            require(&apos;postcss-flexbugs-fixes&apos;),</span><br><span class="line">            autoprefixer(&#123;</span><br><span class="line">              browsers: [</span><br><span class="line">                &apos;last 2 versions&apos;,</span><br><span class="line">              ]</span><br><span class="line">            &#125;),</span><br><span class="line">            cssvariables(&#123;</span><br><span class="line">              preserve: true,</span><br><span class="line">              preserveInjectedVariables: false,</span><br><span class="line">              variables:cssVariablesConfig</span><br><span class="line">            &#125;)</span><br><span class="line">          ],</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;, &#123;</span><br><span class="line">        loader: require.resolve(&apos;less-loader&apos;),</span><br><span class="line">        options: &#123;</span><br><span class="line">          // modifyVars: antdTheme, // 如果配了这属性 要去掉</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在<code>theme.js</code>中，配置各个主题下变量<code>@btnColor</code>的实际值<br></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    default: &#123;</span><br><span class="line">        &apos;@primary-color&apos;: &apos;#ffc847&apos;,</span><br><span class="line">        &apos;@text-color&apos;: &apos;#ffffff&apos;</span><br><span class="line">    &#125;,</span><br><span class="line">    blue: &#123;</span><br><span class="line">        &apos;@primary-color&apos;: &apos;#4560e6&apos;,</span><br><span class="line">        &apos;@text-color&apos;: &apos;#333&apos;</span><br><span class="line">    &#125;,</span><br><span class="line">    yellow: &#123;</span><br><span class="line">        &apos;@primary-color&apos;: &apos;#ff6600&apos;,</span><br><span class="line">        &apos;@text-color&apos;: &apos;#333&apos;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<ul>
<li>调用less.js的modifyVars(option)方法修改主题option:{‘@primary-color’: ‘#fff’}<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">window.less</span><br><span class="line">    .modifyVars(option)</span><br><span class="line">    .then(()=&gt;&#123;</span><br><span class="line">        &lt;!--成功--&gt;</span><br><span class="line">    &#125;)</span><br><span class="line">    .catch(e=&gt;&#123;</span><br><span class="line">        &lt;!--失败--&gt;</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="使用后的问题"><a href="#使用后的问题" class="headerlink" title="使用后的问题"></a>使用后的问题</h3><ul>
<li><p>只适用于less文件</p>
</li>
<li><p>color.js生成的文件内容会存到localstorage中（内容较多）</p>
</li>
<li><p>内联和行内样式，涉及到主题的（color, background-color, border-color等色值属性）应全部改写到less文件中</p>
</li>
<li><p>antd的主题样式在打包时就已经全部引入，但不会影响antd已有的按需加载</p>
</li>
<li><p>antd变量与css变量在命名时需要区分（驼峰和横线）避免在自定义的样式中修改了antd的变量</p>
</li>
<li><p>针对一些其他库（类似echarts）的色值匹配，抽出了公共方法，可根据当前主题类型，使用该类型中的配置属性<br></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// 获取当前账户主题</span><br><span class="line">export const getActiveUserTheme = () =&gt; &#123;</span><br><span class="line">    let userInfo = JSON.parse(sessionStorage.getItem(&apos;userInfo&apos;) || &apos;&#123;&#125;&apos;);</span><br><span class="line">    let themeCustom = JSON.parse(localStorage.getItem(&apos;themeCustom&apos;) || &apos;&#123;&#125;&apos;);</span><br><span class="line">    let type = themeCustom[userInfo.id] || &apos;default&apos;;</span><br><span class="line">    let activeTheme = themeConfig[type];</span><br><span class="line">    return &#123;</span><br><span class="line">        type, // 主题类型</span><br><span class="line">        activeTheme // 该主题类型下的配置对象</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/16/也许能用到的webApi/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="AmamiRyoin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/headImg/head_Img.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="AmamiRyoin's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/16/也许能用到的webApi/" itemprop="url">也许能用到的webApi</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-10-16T19:18:00+08:00">
                2019-10-16
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="一些也许能用到的webApi"><a href="#一些也许能用到的webApi" class="headerlink" title="一些也许能用到的webApi"></a>一些也许能用到的webApi</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>众所周知Web发展到2.0了，html也到5了，其中增加了很多webApi，今天就来挑几个webApi来讲讲。</p>
<h3 id="page-lifecycle-网页生命周期"><a href="#page-lifecycle-网页生命周期" class="headerlink" title="page lifecycle(网页生命周期)"></a>page lifecycle(网页生命周期)</h3><p>这个生命周期可以让我们把控整个网页从诞生到卸载的全部情况，它主要分为以下几个生命周期：</p>
<ul>
<li><p>Active 阶段</p>
<p>  在 Active 阶段，网页处于可见状态，且拥有输入焦点。</p>
</li>
<li><p>Passive 阶段</p>
<p>  在 Passive 阶段，网页可见，但没有输入焦点，无法接受输入。UI 更新（比如动画）仍然在执行。该阶段只可能发生在桌面同时有多个窗口的情况。</p>
</li>
<li><p>Hidden 阶段</p>
<p>  在 Hidden 阶段，用户的桌面被其他窗口占据，网页不可见，但尚未冻结。UI 更新不再执行。</p>
</li>
<li><p>Terminated 阶段</p>
<p>  在 Terminated 阶段，由于用户主动关闭窗口，或者在同一个窗口前往其他页面，导致当前页面开始被浏览器卸载并从内存中清除。注意，这个阶段总是在 Hidden 阶段之后发生，也就是说，用户主动离开当前页面，总是先进入 Hidden 阶段，再进入 Terminated 阶段。</p>
<p>  这个阶段会导致网页卸载，任何新任务都不会在这个阶段启动，并且如果运行时间太长，正在进行的任务可能会被终止。</p>
</li>
<li><p>Frozen 阶段</p>
<p>  如果网页处于 Hidden 阶段的时间过久，用户又不关闭网页，浏览器就有可能冻结网页，使其进入 Frozen 阶段。不过，也有可能，处于可见状态的页面长时间没有操作，也会进入 Frozen 阶段。</p>
<p>  这个阶段的特征是，网页不会再被分配 CPU 计算资源。定时器、回调函数、网络 请求、DOM 操作都不会执行，不过正在运行的任务会执行完。浏览器可能会允许 Frozen 阶段的页面，周期性复苏一小段时间，短暂变回 Hidden 状态，允许一小部分任务执行。</p>
</li>
<li><p>Discarded 阶段</p>
<p>  如果网页长时间处于 Frozen 阶段，用户又不唤醒页面，那么就会进入 Discarded 阶段，即浏览器自动卸载网页，清除该网页的内存占用。不过，Passive 阶段的网页如果长时间没有互动，也可能直接进入 Discarded 阶段。</p>
<p>  这一般是在用户没有介入的情况下，由系统强制执行。任何类型的新任务或 JavaScript 代码，都不能在此阶段执行，因为这时通常处在资源限制的状况下。</p>
<p>  网页被浏览器自动 Discarded 以后，它的 Tab 窗口还是在的。如果用户重新访问这个 Tab 页，浏览器将会重新向服务器发出请求，再一次重新加载网页，回到 Active 阶段。</p>
</li>
</ul>
<p>详细可以看这张流程图</p>
<p><img src="/images/LifecycleCallbacks.png" alt="page lifecycle"></p>
<p>介绍完了网页的各个阶段，现在来介绍一下对应的生命周期有哪些事件。</p>
<ul>
<li><p>focus和blur(聚焦和失焦)</p>
<p>  这里指网页获取焦点和是去焦点，对应的网页周期则是<code>Passive</code>阶段变为<code>Active</code>阶段和<code>Active</code>阶段变为<code>Passive</code>阶段。</p>
</li>
<li><p>visibilitychange</p>
<p>  <code>visibilitychange事件</code>在网页可见状态发生变化时触发，一般发生在以下几种场景。</p>
<ul>
<li>用户隐藏页面（切换 Tab、最小化浏览器），页面由 Active 阶段变成 Hidden 阶段。</li>
<li>用户重新访问隐藏的页面，页面由 Hidden 阶段变成 Active 阶段。</li>
<li>用户关闭页面，页面会先进入 Hidden 阶段，然后进入 Terminated 阶段。<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">document.onvisibilitychange=fn</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>freeze</p>
<p>  freeze事件在网页进入 Frozen 阶段时触发。有个注意点就是从Frozen阶段进入Discarded阶段，不会触发任何事件，无法指定回调函数，只能在进入 Frozen阶段时指定回调函数。关于是否进入Discarded阶段我们可以通过document.wasDiscarded方法来判断，同时，window对象上会新增window.clientId和window.discardedClientId两个属性，用来恢复丢弃前的状态。</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">document.onfreeze = fn</span><br></pre></td></tr></table></figure>
</li>
<li><p>resume</p>
<p>  resume事件在网页离开 Frozen 阶段，变为 Active / Passive / Hidden 阶段时触发。</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">document.resume = fn</span><br></pre></td></tr></table></figure>
</li>
<li><p>pageshow和pagehide</p>
<p>  pageshow事件在用户加载网页时触发，有可能是全新的页面加载，也可能是从缓存中获取的页面。如果是从缓存中获取，则该事件对象的event.persisted属性为true，否则为false。<br>  pagehide事件在用户离开当前网页、进入另一个网页时触发。它的前提是浏览器的 History 记录必须发生变化，跟网页是否可见无关。<br>  虽然这两个事件的目标是document，但必须将其事件处理程序添加到window。</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">var addHandler = function (element, type, handler) &#123;</span><br><span class="line">    if (element.addEventListener) &#123;</span><br><span class="line">        element.addEventListener(type, handler, false);</span><br><span class="line">    &#125; else if (element.attachEvent) &#123;</span><br><span class="line">        element.attachEvent(&quot;on&quot; + type, handler);</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">        element[&quot;on&quot; + type] = handler;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">addHandler(window, &quot;pageshow&quot;, function (event) &#123;</span><br><span class="line">    alert(&quot;pageshow&quot;);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">addHandler(window, &quot;pagehide&quot;, function () &#123;</span><br><span class="line">    alert(&quot;pagehide&quot;);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>beforeunload和unload</p>
<p>  beforeunload事件在窗口或文档即将卸载时触发。该事件发生时，文档仍然可见，此时卸载仍可取消。unload事件在页面正在卸载时触发，经过这个事件，网页进入 Terminated 状态。</p>
</li>
</ul>
<h3 id="online-state（网络状态）"><a href="#online-state（网络状态）" class="headerlink" title="online state（网络状态）"></a>online state（网络状态）</h3><pre><code>获取当前的网络状态，同时也有对应的事件去响应网络状态的变化。

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">window.addEventListener(&apos;online&apos;,onlineHandler)</span><br><span class="line">window.addEventListener(&apos;offline&apos;,offlineHandler)</span><br></pre></td></tr></table></figure>
</code></pre><h3 id="Vibration（震动）"><a href="#Vibration（震动）" class="headerlink" title="Vibration（震动）"></a>Vibration（震动）</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">// 可以传入一个大于0的数字，表示让手机震动相应的时间长度，单位为ms</span><br><span class="line">navigator.vibrate(100)</span><br><span class="line">// 也可以传入一个包含数字的数组，比如下面这样就是代表震动300ms，暂停200ms，震动100ms，暂停400ms，震动100ms</span><br><span class="line">navigator.vibrate([300,200,100,400,100])</span><br><span class="line">// 也可以传入0或者一个全是0的数组，表示暂停震动</span><br><span class="line">navigator.vibrate(0)</span><br></pre></td></tr></table></figure>
<h3 id="execCommand-执行命令"><a href="#execCommand-执行命令" class="headerlink" title="execCommand 执行命令"></a>execCommand 执行命令</h3><p>xeccommand 方法让我们可以通过使用它来执行一些命令，比如复制，剪切，打印，修改选中文字粗体、斜体、背景色、颜色，缩进，插入图片等等等等。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">// 执行打印命令</span><br><span class="line">doc.execCommand(&apos;print&apos;)</span><br><span class="line">// 执行复制命令，复制选中区域</span><br><span class="line">doc.execCommand(&apos;copy&apos;)</span><br><span class="line">// 剪切选中区域</span><br><span class="line">doc.execCommand(&apos;cut&apos;)</span><br><span class="line">// 全选</span><br><span class="line">doc.execCommand(&apos;selectAll&apos;)</span><br><span class="line">// 将选中文字变成粗体，同时接下来输入的文字也会成为粗体，</span><br><span class="line">doc.execCommand(&apos;bold&apos;)</span><br><span class="line">// 将选中文字变成斜体，同时接下来输入的文字也会成为斜体，</span><br><span class="line">doc.execCommand(&apos;italic&apos;)</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/07/10/React源码解读-三-——-React-render/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="AmamiRyoin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/headImg/head_Img.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="AmamiRyoin's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/07/10/React源码解读-三-——-React-render/" itemprop="url">React源码解读(三) —— ReactDOM Api</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-07-10T21:32:40+08:00">
                2019-07-10
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>今天来讲一下ReactDOM的几个Api</p>
<ul>
<li>findDOMNode</li>
<li>unstable_renderSubtreeIntoContainer</li>
<li>unmountComponentAtNode</li>
</ul>
<p>findDOMNode如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">findDOMNode(</span><br><span class="line">    componentOrElement: Element | ?React$Component&lt;any, any&gt;,</span><br><span class="line">  ): null | Element | Text &#123;</span><br><span class="line">    if (__DEV__) &#123;</span><br><span class="line">      let owner = (ReactCurrentOwner.current: any);</span><br><span class="line">      if (owner !== null &amp;&amp; owner.stateNode !== null) &#123;</span><br><span class="line">        const warnedAboutRefsInRender =</span><br><span class="line">          owner.stateNode._warnedAboutRefsInRender;</span><br><span class="line">        warningWithoutStack(</span><br><span class="line">          warnedAboutRefsInRender,</span><br><span class="line">          &apos;%s is accessing findDOMNode inside its render(). &apos; +</span><br><span class="line">            &apos;render() should be a pure function of props and state. It should &apos; +</span><br><span class="line">            &apos;never access something that requires stale data from the previous &apos; +</span><br><span class="line">            &apos;render, such as refs. Move this logic to componentDidMount and &apos; +</span><br><span class="line">            &apos;componentDidUpdate instead.&apos;,</span><br><span class="line">          getComponentName(owner.type) || &apos;A component&apos;,</span><br><span class="line">        );</span><br><span class="line">        owner.stateNode._warnedAboutRefsInRender = true;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    if (componentOrElement == null) &#123;</span><br><span class="line">      return null;</span><br><span class="line">    &#125;</span><br><span class="line">    if ((componentOrElement: any).nodeType === ELEMENT_NODE) &#123;</span><br><span class="line">      return (componentOrElement: any);</span><br><span class="line">    &#125;</span><br><span class="line">    if (__DEV__) &#123;</span><br><span class="line">      return findHostInstanceWithWarning(componentOrElement, &apos;findDOMNode&apos;);</span><br><span class="line">    &#125;</span><br><span class="line">    return findHostInstance(componentOrElement);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>unmountComponentAtNode和unstable_renderSubtreeIntoContainer如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">unstable_renderSubtreeIntoContainer(</span><br><span class="line">    parentComponent: React$Component&lt;any, any&gt;,</span><br><span class="line">    element: React$Element&lt;any&gt;,</span><br><span class="line">    containerNode: DOMContainer,</span><br><span class="line">    callback: ?Function,</span><br><span class="line">  ) &#123;</span><br><span class="line">    invariant(</span><br><span class="line">      isValidContainer(containerNode),</span><br><span class="line">      &apos;Target container is not a DOM element.&apos;,</span><br><span class="line">    );</span><br><span class="line">    invariant(</span><br><span class="line">      parentComponent != null &amp;&amp; hasInstance(parentComponent),</span><br><span class="line">      &apos;parentComponent must be a valid React Component&apos;,</span><br><span class="line">    );</span><br><span class="line">    return legacyRenderSubtreeIntoContainer(</span><br><span class="line">      parentComponent,</span><br><span class="line">      element,</span><br><span class="line">      containerNode,</span><br><span class="line">      false,</span><br><span class="line">      callback,</span><br><span class="line">    );</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  unmountComponentAtNode(container: DOMContainer) &#123;</span><br><span class="line">    invariant(</span><br><span class="line">      isValidContainer(container),</span><br><span class="line">      &apos;unmountComponentAtNode(...): Target container is not a DOM element.&apos;,</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    if (__DEV__) &#123;</span><br><span class="line">      warningWithoutStack(</span><br><span class="line">        !container._reactHasBeenPassedToCreateRootDEV,</span><br><span class="line">        &apos;You are calling ReactDOM.unmountComponentAtNode() on a container that was previously &apos; +</span><br><span class="line">          &apos;passed to ReactDOM.%s(). This is not supported. Did you mean to call root.unmount()?&apos;,</span><br><span class="line">        enableStableConcurrentModeAPIs ? &apos;createRoot&apos; : &apos;unstable_createRoot&apos;,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (container._reactRootContainer) &#123;</span><br><span class="line">      if (__DEV__) &#123;</span><br><span class="line">        const rootEl = getReactRootElementInContainer(container);</span><br><span class="line">        const renderedByDifferentReact = rootEl &amp;&amp; !getInstanceFromNode(rootEl);</span><br><span class="line">        warningWithoutStack(</span><br><span class="line">          !renderedByDifferentReact,</span><br><span class="line">          &quot;unmountComponentAtNode(): The node you&apos;re attempting to unmount &quot; +</span><br><span class="line">            &apos;was rendered by another copy of React.&apos;,</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      // Unmount should not be batched.</span><br><span class="line">      unbatchedUpdates(() =&gt; &#123;</span><br><span class="line">        legacyRenderSubtreeIntoContainer(null, null, container, false, () =&gt; &#123;</span><br><span class="line">          container._reactRootContainer = null;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">      // If you call unmountComponentAtNode twice in quick succession, you&apos;ll</span><br><span class="line">      // get `true` twice. That&apos;s probably fine?</span><br><span class="line">      return true;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      if (__DEV__) &#123;</span><br><span class="line">        const rootEl = getReactRootElementInContainer(container);</span><br><span class="line">        const hasNonRootReactChild = !!(rootEl &amp;&amp; getInstanceFromNode(rootEl));</span><br><span class="line"></span><br><span class="line">        // Check if the container itself is a React root node.</span><br><span class="line">        const isContainerReactRoot =</span><br><span class="line">          container.nodeType === ELEMENT_NODE &amp;&amp;</span><br><span class="line">          isValidContainer(container.parentNode) &amp;&amp;</span><br><span class="line">          !!container.parentNode._reactRootContainer;</span><br><span class="line"></span><br><span class="line">        warningWithoutStack(</span><br><span class="line">          !hasNonRootReactChild,</span><br><span class="line">          &quot;unmountComponentAtNode(): The node you&apos;re attempting to unmount &quot; +</span><br><span class="line">            &apos;was rendered by React and is not a top-level container. %s&apos;,</span><br><span class="line">          isContainerReactRoot</span><br><span class="line">            ? &apos;You may have accidentally passed in a React root node instead &apos; +</span><br><span class="line">              &apos;of its container.&apos;</span><br><span class="line">            : &apos;Instead, have the parent component update its state and &apos; +</span><br><span class="line">              &apos;rerender in order to remove this component.&apos;,</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      return false;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  export type DOMContainer =</span><br><span class="line">  | (Element &amp; &#123;</span><br><span class="line">      _reactRootContainer: ?(_ReactRoot | _ReactSyncRoot),</span><br><span class="line">      _reactHasBeenPassedToCreateRootDEV: ?boolean,</span><br><span class="line">    &#125;)</span><br><span class="line">  | (Document &amp; &#123;</span><br><span class="line">      _reactRootContainer: ?(_ReactRoot | _ReactSyncRoot),</span><br><span class="line">      _reactHasBeenPassedToCreateRootDEV: ?boolean,</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/25/React源码解读-二-——React-createElement/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="AmamiRyoin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/headImg/head_Img.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="AmamiRyoin's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/25/React源码解读-二-——React-createElement/" itemprop="url">React源码解读(二) —— React.createElement</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-25T10:09:46+08:00">
                2019-04-25
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在说createElement之前，首先来比较下下面两种写法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">//写法一</span><br><span class="line">let pDom=document.createElement(&quot;p&quot;);</span><br><span class="line">let textNode=document.createTextNode(&quot;text&quot;);</span><br><span class="line">pDom.appendChild(textNode);</span><br><span class="line">let rootElement=document.getElementById(&quot;root&quot;);</span><br><span class="line">rootElement.appendChild(pDom);</span><br><span class="line"></span><br><span class="line">//写法二</span><br><span class="line">let pDom = &lt;p&gt;text&lt;/p&gt;</span><br><span class="line">return &lt;div id=&apos;root&apos;&gt;&#123;pDom&#125;&lt;/div&gt;</span><br></pre></td></tr></table></figure>
<p>以上两种写法分别是js写法和react写法,很显然,相较于写法一,写法二更符合我们书写html的习惯而且代码也更容易阅读。<br>那么为什么能用写法二来写呢，我们把代码放进babel里面看一下。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">var pDom = React.createElement(&quot;p&quot;, null, &quot;text&quot;);</span><br><span class="line">return React.createElement(&quot;div&quot;, &#123;</span><br><span class="line">    id: &quot;root&quot;</span><br><span class="line">&#125;, pDom);</span><br></pre></td></tr></table></figure>
<p>可以看到写法二的代码被转成了上述的样子，即,用React.createElement创建了dom节点（虚拟）。我们可以打印看下这个pDom是个什么东西。</p>
<p><img src="/images/createElement1.png" alt="pDom"></p>
<p>从中可以看出pDom实际上就是一个js对象，有如下属性。</p>
<ul>
<li><code>$$typeof</code> 唯一标志，它是一个Symbol对象，具有唯一性，在redux中给actions命名的时候用起来很爽。</li>
<li><code>key</code> DOM结构标识，提升diff算法性能。</li>
<li><code>props</code> 标签属性。</li>
<li><code>ref</code> 标志真实Dom引用。</li>
<li><code>type</code> 该虚拟dom的标签类型。</li>
<li><code>_owner</code> 16版本新加的东西，是个FiberNode对象，直译就是纤维节点，可以理解成片段节点。</li>
<li><code>_store</code> 暂时不清楚（源码里也没看懂用来干嘛的）<br>所以可以这样理解，虚拟节点就是react对dom的一个解析并将其用js对象表示出来。</li>
</ul>
<p>现在来看下createElement的源码。</p>
<p>首先来看下入参。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">const RESERVED_PROPS = &#123;    //需要过滤的propNames</span><br><span class="line">  key: true,</span><br><span class="line">  ref: true,</span><br><span class="line">  __self: true,</span><br><span class="line">  __source: true,</span><br><span class="line">&#125;;</span><br><span class="line">export function createElement(type, config, children) &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结合之前看的babel编译后的代码我们可以看出来type,config,children代表什么，type是指节点，config是指传给该标签的属性，children是子节点。<br>接下来看内部代码。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">let propName;</span><br><span class="line"></span><br><span class="line">  // Reserved names are extracted</span><br><span class="line">  const props = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  let key = null;</span><br><span class="line">  let ref = null;</span><br><span class="line">  let self = null;</span><br><span class="line">  let source = null;</span><br><span class="line"></span><br><span class="line">  if (config != null) &#123;</span><br><span class="line">    if (hasValidRef(config)) &#123;  //判断config中是否存在ref</span><br><span class="line">      ref = config.ref;</span><br><span class="line">    &#125;</span><br><span class="line">    if (hasValidKey(config)) &#123;  //判断config中是否存在key</span><br><span class="line">      key = &apos;&apos; + config.key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    self = config.__self === undefined ? null : config.__self;</span><br><span class="line">    source = config.__source === undefined ? null : config.__source;</span><br><span class="line"></span><br><span class="line">    // Remaining properties are added to a new props object</span><br><span class="line">    for (propName in config) &#123;      //遍历属性并将其添加到props里面</span><br><span class="line">      if (</span><br><span class="line">        hasOwnProperty.call(config, propName) &amp;&amp;</span><br><span class="line">        !RESERVED_PROPS.hasOwnProperty(propName)    //这里是过滤不需要绑定的propNames</span><br><span class="line">      ) &#123;</span><br><span class="line">        props[propName] = config[propName];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>再接下来就是children的处理。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">// Children can be more than one argument, and those are transferred onto</span><br><span class="line">// the newly allocated props object.</span><br><span class="line">  const childrenLength = arguments.length - 2;</span><br><span class="line">  if (childrenLength === 1) &#123;   //这里就解释了为什么当你标签下只有一个子标签的时候你用数组方式无法取到</span><br><span class="line">    props.children = children;</span><br><span class="line">  &#125; else if (childrenLength &gt; 1) &#123;</span><br><span class="line">    const childArray = Array(childrenLength);</span><br><span class="line">    for (let i = 0; i &lt; childrenLength; i++) &#123;</span><br><span class="line">      childArray[i] = arguments[i + 2];</span><br><span class="line">    &#125;</span><br><span class="line">    if (__DEV__) &#123;          //开发环境下的特殊操作</span><br><span class="line">      if (Object.freeze) &#123;</span><br><span class="line">        Object.freeze(childArray);  //es6语法，freeze方法可以冻结一个对象使其无法被操作</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    props.children = childArray;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>在接下来</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">// Resolve default props</span><br><span class="line">  if (type &amp;&amp; type.defaultProps) &#123;</span><br><span class="line">    const defaultProps = type.defaultProps;</span><br><span class="line">    for (propName in defaultProps) &#123;    //将defaultProps添加到props里面</span><br><span class="line">      if (props[propName] === undefined) &#123;</span><br><span class="line">        props[propName] = defaultProps[propName];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  if (__DEV__) &#123;</span><br><span class="line">    if (key || ref) &#123;</span><br><span class="line">      const displayName =</span><br><span class="line">        typeof type === &apos;function&apos;</span><br><span class="line">          ? type.displayName || type.name || &apos;Unknown&apos;  //标签名的获取</span><br><span class="line">          : type;</span><br><span class="line">      if (key) &#123;</span><br><span class="line">        defineKeyPropWarningGetter(props, displayName); //用来把key添加中props中。</span><br><span class="line">      &#125;</span><br><span class="line">      if (ref) &#123;</span><br><span class="line">        defineRefPropWarningGetter(props, displayName); //用来把ref添加中props中。</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">function defineKeyPropWarningGetter(props, displayName) &#123;</span><br><span class="line">  const warnAboutAccessingKey = function() &#123;</span><br><span class="line">    if (!specialPropKeyWarningShown) &#123;</span><br><span class="line">      specialPropKeyWarningShown = true;</span><br><span class="line">      warningWithoutStack(</span><br><span class="line">        false,</span><br><span class="line">        &apos;%s: `key` is not a prop. Trying to access it will result &apos; +</span><br><span class="line">          &apos;in `undefined` being returned. If you need to access the same &apos; +</span><br><span class="line">          &apos;value within the child component, you should pass it as a different &apos; +</span><br><span class="line">          &apos;prop. (https://fb.me/react-special-props)&apos;,</span><br><span class="line">        displayName,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  warnAboutAccessingKey.isReactWarning = true;</span><br><span class="line">  Object.defineProperty(props, &apos;key&apos;, &#123;         //在props中添加一个key属性，并将get和configurable赋给key</span><br><span class="line">    get: warnAboutAccessingKey,</span><br><span class="line">    configurable: true,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function defineRefPropWarningGetter(props, displayName) &#123;</span><br><span class="line">  const warnAboutAccessingRef = function() &#123;</span><br><span class="line">    if (!specialPropRefWarningShown) &#123;</span><br><span class="line">      specialPropRefWarningShown = true;</span><br><span class="line">      warningWithoutStack(</span><br><span class="line">        false,</span><br><span class="line">        &apos;%s: `ref` is not a prop. Trying to access it will result &apos; +</span><br><span class="line">          &apos;in `undefined` being returned. If you need to access the same &apos; +</span><br><span class="line">          &apos;value within the child component, you should pass it as a different &apos; +</span><br><span class="line">          &apos;prop. (https://fb.me/react-special-props)&apos;,</span><br><span class="line">        displayName,</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  warnAboutAccessingRef.isReactWarning = true;</span><br><span class="line">  Object.defineProperty(props, &apos;ref&apos;, &#123;             //在props中添加一个ref属性，并将get和configurable赋给ref</span><br><span class="line">    get: warnAboutAccessingRef,</span><br><span class="line">    configurable: true,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后就是返回一个ReactElement对象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">return ReactElement(</span><br><span class="line">    type,</span><br><span class="line">    key,</span><br><span class="line">    ref,</span><br><span class="line">    self,</span><br><span class="line">    source,</span><br><span class="line">    ReactCurrentOwner.current,</span><br><span class="line">    props,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">const ReactElement = function(type, key, ref, self, source, owner, props) &#123;</span><br><span class="line">    const element = &#123;</span><br><span class="line">      // This tag allows us to uniquely identify this as a React Element</span><br><span class="line">      $$typeof: REACT_ELEMENT_TYPE,</span><br><span class="line"></span><br><span class="line">      // Built-in properties that belong on the element</span><br><span class="line">      type: type,</span><br><span class="line">      key: key,</span><br><span class="line">      ref: ref,</span><br><span class="line">      props: props,</span><br><span class="line"></span><br><span class="line">      // Record the component responsible for creating this element.</span><br><span class="line">      _owner: owner,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    if (__DEV__) &#123;</span><br><span class="line">      // The validation flag is currently mutative. We put it on</span><br><span class="line">      // an external backing store so that we can freeze the whole object.</span><br><span class="line">      // This can be replaced with a WeakMap once they are implemented in</span><br><span class="line">      // commonly used development environments.</span><br><span class="line">      element._store = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">      // To make comparing ReactElements easier for testing purposes, we make</span><br><span class="line">      // the validation flag non-enumerable (where possible, which should</span><br><span class="line">      // include every environment we run tests in), so the test framework</span><br><span class="line">      // ignores it.</span><br><span class="line">      Object.defineProperty(element._store, &apos;validated&apos;, &#123;</span><br><span class="line">        configurable: false,</span><br><span class="line">        enumerable: false,</span><br><span class="line">        writable: true,</span><br><span class="line">        value: false,</span><br><span class="line">      &#125;);</span><br><span class="line">      // self and source are DEV only properties.</span><br><span class="line">      Object.defineProperty(element, &apos;_self&apos;, &#123;</span><br><span class="line">        configurable: false,</span><br><span class="line">        enumerable: false,</span><br><span class="line">        writable: false,</span><br><span class="line">        value: self,</span><br><span class="line">      &#125;);</span><br><span class="line">      // Two elements created in two different places should be considered</span><br><span class="line">      // equal for testing purposes and therefore we hide it from enumeration.</span><br><span class="line">      Object.defineProperty(element, &apos;_source&apos;, &#123;</span><br><span class="line">        configurable: false,</span><br><span class="line">        enumerable: false,</span><br><span class="line">        writable: false,</span><br><span class="line">        value: source,</span><br><span class="line">      &#125;);</span><br><span class="line">      if (Object.freeze) &#123;</span><br><span class="line">        Object.freeze(element.props);</span><br><span class="line">        Object.freeze(element);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    return element;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>以上</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/04/24/React源码解读-一/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="AmamiRyoin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/headImg/head_Img.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="AmamiRyoin's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/04/24/React源码解读-一/" itemprop="url">React源码解读(一) ——— ReactDom.render()</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-04-24T20:54:25+08:00">
                2019-04-24
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="React源码解读-一"><a href="#React源码解读-一" class="headerlink" title="React源码解读(一)"></a>React源码解读(一)</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这两周面试了几个人，虽然是一面，问的不深，但是给我的感觉都是对React了解的比较浅，稍微往深一点问基本都是回答得很宽泛，答不到点子上，虽然有引导他们去思考但是由于react的理解很片面所以基本也答不出来，因此就来写个我对于react的源码的解读，我将从项目结构入手分析React源码。</p>
<h2 id="ReactDOM-render-github上ReactDOM-js-672行"><a href="#ReactDOM-render-github上ReactDOM-js-672行" class="headerlink" title="ReactDOM.render() (github上ReactDOM.js 672行)"></a>ReactDOM.render() (github上ReactDOM.js 672行)</h2><p>一个React项目的最外层就是一个指定的DOM节点，通过render函数将我们需要渲染的组件插入到指定DOM节点中来实现视图，来看看render到底做了什么。<br>源码如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">render(</span><br><span class="line">    element: React$Element&lt;any&gt;,</span><br><span class="line">    container: DOMContainer,</span><br><span class="line">    callback: ?Function,</span><br><span class="line">) &#123;</span><br><span class="line">    return legacyRenderSubtreeIntoContainer(    //legacyRenderSubtreeIntoContainer 遗留渲染子树到容器（这名字我只能这么白话翻译了，读不懂）</span><br><span class="line">        null,</span><br><span class="line">        element,</span><br><span class="line">        container,</span><br><span class="line">        false,</span><br><span class="line">        callback,</span><br><span class="line">    );</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">function legacyRenderSubtreeIntoContainer(</span><br><span class="line">    parentComponent: ?React$Component&lt;any, any&gt;,    //父组件</span><br><span class="line">    children: ReactNodeList,                        //子组件，ReactElement</span><br><span class="line">    container: DOMContainer,                        //DOM容器</span><br><span class="line">    forceHydrate: boolean,                          //强制注水(用于ssr，寓意使干巴巴的数据变成水灵灵的HTML)</span><br><span class="line">    callback: ?Function,                            //回调</span><br><span class="line">) &#123;</span><br><span class="line">  // TODO: Without `any` type, Flow says &quot;Property cannot be accessed on any</span><br><span class="line">  // member of intersection type.&quot; Whyyyyyy.</span><br><span class="line">  let root: Root = (container._reactRootContainer: any);</span><br><span class="line">  if (!root) &#123;          //不存在container._reactRootContainer时，及第一次渲染</span><br><span class="line">    // Initial mount            //初始化React根节点（虚拟DOM）</span><br><span class="line">    root = container._reactRootContainer = legacyCreateRootFromDOMContainer(    //其实是个ReactRoot对象</span><br><span class="line">      container,</span><br><span class="line">      forceHydrate,</span><br><span class="line">    );</span><br><span class="line">    if (typeof callback === &apos;function&apos;) &#123;</span><br><span class="line">      const originalCallback = callback;</span><br><span class="line">      callback = function() &#123;</span><br><span class="line">        const instance = getPublicRootInstance(root._internalRoot);</span><br><span class="line">        originalCallback.call(instance);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    // Initial mount should not be batched.</span><br><span class="line">    unbatchedUpdates(() =&gt; &#123;</span><br><span class="line">      if (parentComponent != null) &#123;</span><br><span class="line">        root.legacy_renderSubtreeIntoContainer(</span><br><span class="line">          parentComponent,</span><br><span class="line">          children,</span><br><span class="line">          callback,</span><br><span class="line">        );</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        root.render(children, callback);    //root对象会去走这个render方法</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    if (typeof callback === &apos;function&apos;) &#123;</span><br><span class="line">      const originalCallback = callback;</span><br><span class="line">      callback = function() &#123;</span><br><span class="line">        const instance = getPublicRootInstance(root._internalRoot);</span><br><span class="line">        originalCallback.call(instance);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    // Update</span><br><span class="line">    if (parentComponent != null) &#123;</span><br><span class="line">      root.legacy_renderSubtreeIntoContainer(</span><br><span class="line">        parentComponent,</span><br><span class="line">        children,</span><br><span class="line">        callback,</span><br><span class="line">      );</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      root.render(children, callback);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return getPublicRootInstance(root._internalRoot);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>由于render方法在React生命周期各个时期中有着不同的作用，因此render中分了首次挂载和更新两种情况。</p>
<p>首次挂载时，通过legacyCreateRootFromDOMContainer生成了一个root对象，并将这个root对象赋给了DOM容器,下面来看看<code>legacyCreateRootFromDOMContainer</code>。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">function legacyCreateRootFromDOMContainer(</span><br><span class="line">  container: DOMContainer,</span><br><span class="line">  forceHydrate: boolean,</span><br><span class="line">): Root &#123;</span><br><span class="line">  const shouldHydrate =</span><br><span class="line">    forceHydrate || shouldHydrateDueToLegacyHeuristic(container);</span><br><span class="line">  // First clear any existing content.</span><br><span class="line">  if (!shouldHydrate) &#123;</span><br><span class="line">    let warned = false;</span><br><span class="line">    let rootSibling;</span><br><span class="line">    while ((rootSibling = container.lastChild)) &#123;</span><br><span class="line">      container.removeChild(rootSibling);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  // Legacy roots are not async by default.</span><br><span class="line">  const isConcurrent = false;</span><br><span class="line">  return new ReactRoot(container, isConcurrent, shouldHydrate);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看出来它干了两件事情，一个是当不应该注水的时候清空了container的子节点（应该就是非ssr的情况下），还有一件事情就是返回了一个新的ReactRoot对象。问题又来了这个ReactRoot又是个什么东西。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">function ReactRoot(</span><br><span class="line">  container: DOMContainer,</span><br><span class="line">  isConcurrent: boolean,</span><br><span class="line">  hydrate: boolean,</span><br><span class="line">) &#123;</span><br><span class="line">  const root = createContainer(container, isConcurrent, hydrate);</span><br><span class="line">  this._internalRoot = root;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ReactRoot.prototype.render = function(      //渲染</span><br><span class="line">  children: ReactNodeList,</span><br><span class="line">  callback: ?() =&gt; mixed,</span><br><span class="line">): Work &#123;</span><br><span class="line">  const root = this._internalRoot;</span><br><span class="line">  const work = new ReactWork();</span><br><span class="line">  callback = callback === undefined ? null : callback;</span><br><span class="line">  if (callback !== null) &#123;</span><br><span class="line">    work.then(callback);</span><br><span class="line">  &#125;</span><br><span class="line">  updateContainer(children, root, null, work._onCommit);    //最终会执行updateContainer方法并返回一个ReactWork对象</span><br><span class="line">  return work;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">ReactRoot.prototype.legacy_renderSubtreeIntoContainer = function(           </span><br><span class="line">  parentComponent: ?React$Component&lt;any, any&gt;,</span><br><span class="line">  children: ReactNodeList,</span><br><span class="line">  callback: ?() =&gt; mixed,</span><br><span class="line">): Work &#123;</span><br><span class="line">  const root = this._internalRoot;</span><br><span class="line">  const work = new ReactWork();</span><br><span class="line">  callback = callback === undefined ? null : callback;</span><br><span class="line">  if (callback !== null) &#123;</span><br><span class="line">    work.then(callback);</span><br><span class="line">  &#125;</span><br><span class="line">  updateContainer(children, root, parentComponent, work._onCommit);</span><br><span class="line">  return work;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>从上面可以看出来这个ReactRoot是个构造函数，它有render等方法，上述的root则会去执行render方法并返回一个ReactWork对象，那接下来就是这个updateContainer到底干了些什么了。通过上面的层层扒皮，无论怎样判断，最终都会到render方法和legacy_renderSubtreeIntoContainer方法中，而这两个方法的核心就是updateContainer，无非就是传不传父组件而已。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">export function updateContainer(</span><br><span class="line">  element: ReactNodeList,</span><br><span class="line">  container: OpaqueRoot,</span><br><span class="line">  parentComponent: ?React$Component&lt;any, any&gt;,</span><br><span class="line">  callback: ?Function,</span><br><span class="line">): ExpirationTime &#123;</span><br><span class="line">  const current = container.current;</span><br><span class="line">  const currentTime = requestCurrentTime();</span><br><span class="line">  const expirationTime = computeExpirationForFiber(currentTime, current);</span><br><span class="line">  return updateContainerAtExpirationTime(</span><br><span class="line">    element,</span><br><span class="line">    container,</span><br><span class="line">    parentComponent,</span><br><span class="line">    expirationTime,</span><br><span class="line">    callback,</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line">export function updateContainerAtExpirationTime(</span><br><span class="line">  element: ReactNodeList,</span><br><span class="line">  container: OpaqueRoot,</span><br><span class="line">  parentComponent: ?React$Component&lt;any, any&gt;,</span><br><span class="line">  expirationTime: ExpirationTime,</span><br><span class="line">  callback: ?Function,</span><br><span class="line">) &#123;</span><br><span class="line">  // TODO: If this is a nested container, this won&apos;t be the root.</span><br><span class="line">  const current = container.current;</span><br><span class="line"></span><br><span class="line">  const context = getContextForSubtree(parentComponent);</span><br><span class="line">  if (container.context === null) &#123;</span><br><span class="line">    container.context = context;</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    container.pendingContext = context;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  return scheduleRootUpdate(current, element, expirationTime, callback);    //根更新计划表</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function scheduleRootUpdate(</span><br><span class="line">  current: Fiber,</span><br><span class="line">  element: ReactNodeList,</span><br><span class="line">  expirationTime: ExpirationTime,</span><br><span class="line">  callback: ?Function,</span><br><span class="line">) &#123;</span><br><span class="line"></span><br><span class="line">  const update = createUpdate(expirationTime);</span><br><span class="line">  // Caution: React DevTools currently depends on this property</span><br><span class="line">  // being called &quot;element&quot;.</span><br><span class="line">  update.payload = &#123;element&#125;;</span><br><span class="line"></span><br><span class="line">  callback = callback === undefined ? null : callback;</span><br><span class="line">  if (callback !== null) &#123;</span><br><span class="line">    update.callback = callback;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  flushPassiveEffects();</span><br><span class="line">  enqueueUpdate(current, update);</span><br><span class="line">  scheduleWork(current, expirationTime);</span><br><span class="line"></span><br><span class="line">  return expirationTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>updateContainer传入的参数有虚拟dom对象树、之前造出来的root中和fiber相关的_internalRoot、父组件、回调函数。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/28/React-Hooks理解/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="AmamiRyoin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/headImg/head_Img.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="AmamiRyoin's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/28/React-Hooks理解/" itemprop="url">React Hooks看法</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-28T10:42:38+08:00">
                2019-02-28
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>继上次分享了React新特性，当然参考了论坛中一些人的看法，在社区中，大部分布道者都提到了诸如“过于冗繁的组件嵌套”、“与内部原理的更亲密接触”、“比原先更细粒度的逻辑组织与复用”等优势，这次来谈下对于新特性中的hooks的看法。</p>
<p>React新特性中的hooks强调了用函数式组件的思想来代替类组件，然而这个也颠覆了react中原本函数式组件的写法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function TextComponent(text)&#123;</span><br><span class="line">    return &lt;p&gt;&#123;text&#125;&lt;/p&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上例代码是一个非常简单的函数组件，只依赖入参。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">function TextComponent()&#123;</span><br><span class="line">    let [text,changeText] = useState(&apos;hello&apos;);</span><br><span class="line">    return &lt;p&gt;&#123;text&#125;&lt;/p&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上例代码是用了hooks的一个函数组件。<br>虽然在功能上两种写法是一致，但是可以看出hooks的组件并不是纯粹的<code>输入到输出</code>，而是变成了<code>changeText</code>方法控制的输出，text是依赖changeText方法的。也就是说对于函数组件来说更多地去依赖了changeText方法这一逻辑控制。</p>
<p>在这里我们可以先讨论下关于类组件和函数组件。</p>
<p>某些情况下函数组件可以直接代替类组件，但函数组件和类组件之间最大的区别就是一个有状态机制，一个没有状态机制。函数组价没有内部状态变化机制，只能从外部进行状态的驱动。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function Hello(props, context) &#123;</span><br><span class="line">  return &lt;span&gt;Hello &#123;props.name&#125;&lt;/span&gt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">class Hello extends Component &#123;</span><br><span class="line">  state = &#123;</span><br><span class="line">    name: &apos;haha&apos;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  handleClick=()=&gt;&#123;</span><br><span class="line">    this.setState(&#123;</span><br><span class="line">      name: &apos;hehe&apos;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  render() &#123;</span><br><span class="line">    return &lt;span onClick=&#123;this.handleClick&#125;&gt;Hello &#123;this.state.name&#125;&lt;/span&gt;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>状态机制的存在使得函数组件无法取代类组件，因此我们写代码的时候更多的都是去写类组件。<br>但类组件也有很多不足之处。</p>
<ul>
<li><p>标签嵌套地狱</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">render() &#123;</span><br><span class="line">  return (</span><br><span class="line">    &lt;FooContext.Provider value=&#123;this.state.foo&#125;&gt;</span><br><span class="line">      &lt;BarContext.Provider value=&#123;this.state.bar&#125;&gt;</span><br><span class="line">        &lt;BarContext.Consumer&gt;</span><br><span class="line">          &#123;bar =&gt; (</span><br><span class="line">            &lt;FooContext.Consumer&gt;</span><br><span class="line">              &#123;foo =&gt; (</span><br><span class="line">                console.log(bar, foo)</span><br><span class="line">              )&#125;</span><br><span class="line">            &lt;/FooContext.Consumer&gt;</span><br><span class="line">          )&#125;</span><br><span class="line">        &lt;/BarContext.Consumer&gt;</span><br><span class="line">      &lt;/BarContext.Provider&gt;</span><br><span class="line">    &lt;/FooContext.Provider&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>一些有状态的逻辑比较难重用,需要大量借助Context</p>
</li>
</ul>
<p>其实这个也是react的不足之处，因此React团队基于函数组件提出hooks的概念。</p>
<p>以上的例子可以综合成下面这个hook例子<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">import &#123; useState, useContext, useEffect, createContext &#125; from &apos;react&apos;;</span><br><span class="line">const FooContext = createContext(&apos;foo&apos;);</span><br><span class="line">const BarContext = createContext(&apos;bar&apos;);</span><br><span class="line"></span><br><span class="line">function Hello(props, context) &#123;</span><br><span class="line">  const [name, setName] = useState(&apos;haha&apos;);</span><br><span class="line"></span><br><span class="line">  const foo = useContext(FooContext);</span><br><span class="line">  const bar = useContext(BarContext);</span><br><span class="line"></span><br><span class="line">  const handleClick = () =&gt; setName(&apos;hehe&apos;);</span><br><span class="line"></span><br><span class="line">  useEffect(() =&gt; &#123;</span><br><span class="line">    return () =&gt; &#123;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, [name]);</span><br><span class="line"></span><br><span class="line">  return (</span><br><span class="line">    &lt;&gt;</span><br><span class="line">      &lt;span onClick=&#123;handleClick&#125;&gt;Hello &#123;name&#125;&lt;/span&gt;</span><br><span class="line"></span><br><span class="line">      &lt;FooContext.Provider&gt;</span><br><span class="line">        &lt;BarContext.Provider&gt;</span><br><span class="line">          &#123;foo&#125;, &#123;bar&#125;</span><br><span class="line">        &lt;/BarContext.Provider&gt;</span><br><span class="line">      &lt;/FooContext.Provider&gt;</span><br><span class="line">    &lt;/&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>从上面其实可以看出一些react团队的编码思想。</p>
<ul>
<li><code>let [text,changeText] = useState(&#39;hello&#39;)</code>这种写法可以让<code>状态和逻辑</code>两两配对，并且因为使用者可以用useState自定义各种hooks，所以可以让开发者更好地处理代码结构；</li>
<li>状态的颗粒度可以很小，由于配对的原因可控范围也很小，对于整体的影响范围不大，单个组件中能用多个hook来进行状态修改，甚至可以拆分成多个组件或状态；<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">let &#123; useState, useEffect &#125; = require(&apos;react&apos;);</span><br><span class="line"></span><br><span class="line">function useIsHear() &#123;</span><br><span class="line">  let [isHear, setIsHear] = useState(false);</span><br><span class="line"></span><br><span class="line">  function isHearChange() &#123;</span><br><span class="line">    setIsHear(true);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  useEffect(() =&gt; &#123;</span><br><span class="line">    isHearChange()</span><br><span class="line">    return () =&gt; &#123;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;, [isHear]);</span><br><span class="line"></span><br><span class="line">  return isHear;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function Answer() &#123;</span><br><span class="line">  let isHear = useIsHear();</span><br><span class="line">  return &#123;isHear ? &lt;span&gt;answer&lt;/span&gt;:&lt;span&gt;leave&lt;/span&gt;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>通过hooks可以方便的把状态进行分离，每一个状态分离后可复用，通过组合的方式提供一种有状态逻辑的复用。</p>
<ul>
<li>通过hooks更容易实现逻辑与展示的分离，函数组件依然会是一个实现渲染逻辑的纯组件，对状态的管理已经被hooks内部所实现，即有状态无渲染和有渲染无状态；<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">function Hello(props)&#123;</span><br><span class="line">    return &lt;p&gt;Hello &#123;props.name&#125;&lt;/p&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function useHello()&#123;</span><br><span class="line">    let [hello,setHello] = useState(&apos;hello&apos;);</span><br><span class="line">    return [hello,setHello];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/headImg/head_Img.jpg"
                alt="AmamiRyoin" />
            
              <p class="site-author-name" itemprop="name">AmamiRyoin</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives">
              
                  <span class="site-state-item-count">20</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/AmamiRyoin" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://twitter.com/RyoinAmami" target="_blank" title="Twitter">
                      
                        <i class="fa fa-fw fa-twitter"></i>Twitter</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">AmamiRyoin</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Gemini</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

  <canvas></canvas>
  <script type="text/javascript">
    document.getElementsByTagName('canvas')[0].style="position:fixed;top:0;bottom:0;left:0;right:0;width: 100%;height: 100%;pointer-events: none;z-index: -1;";
    document.addEventListener('touchmove', function (e) {
                e.preventDefault()
            })
            var c = document.getElementsByTagName('canvas')[0],
                x = c.getContext('2d'),
                pr = window.devicePixelRatio || 1,
                w = window.innerWidth,
                h = window.innerHeight,
                f = 90,
                q,
                m = Math,
                r = 0,
                u = m.PI*2,
                v = m.cos,
                z = m.random
            c.width = w*pr
            c.height = h*pr
            x.scale(pr, pr)
            x.globalAlpha = 0.6
            function i(){
                x.clearRect(0,0,w,h)
                q=[{x:0,y:h*.7+f},{x:0,y:h*.7-f}]
                while(q[1].x<w+f) d(q[0], q[1])
            }
            function d(i,j){
                x.beginPath()
                x.moveTo(i.x, i.y)
                x.lineTo(j.x, j.y)
                var k = j.x + (z()*2-0.25)*f,
                    n = y(j.y)
                x.lineTo(k, n)
                x.closePath()
                r-=u/-50
                x.fillStyle = '#'+(v(r)*127+128<<16 | v(r+u/3)*127+128<<8 | v(r+u/3*2)*127+128).toString(16)
                x.fill()
                q[0] = q[1]
                q[1] = {x:k,y:n}
            }
            function y(p){
                var t = p + (z()*2-1.1)*f
                return (t>h||t<0) ? y(p) : t
            }
            document.onclick = i
            document.ontouchstart = i
            i()
  </script>
</body>
</html>
